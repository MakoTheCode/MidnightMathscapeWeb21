<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Login | St. Michael Academy</title>
    <link rel="stylesheet" href="mainCSS.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container-wrap">
        <div class="-main">
            <div class="main-image">
                <img src="images/main image.PNG" alt="logo" width="550" height="550" title="St. Michael Academy">
            </div>
        </div>

        <div class="-side">
            <div class="flip-container">
                <div class="flip-inner">
                    <div class="flip-front">
                        <img src="images/academy logo.jpg" alt="logo" width="60" height="55" title="St. Michael Academy">
                        <h2>Teacher Login</h2>
                        <p>Track your student's progress and performance inside Midnight Mathscape.</p>
                        <h3>__________________________________</h3>
                        
                        <form id="loginFormElement">
                            <a>Email</a>
                            <div class="input-group">
                                <i class="fas fa-envelope"></i>
                                <input type="email" id="loginEmail" placeholder="Email" required>
                            </div>
                            <span class="error-message" id="loginEmailError"></span>
                            
                            <a>Password</a>
                            <div class="input-group">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="loginPassword" placeholder="Password" required>
                            </div>
                            <span class="error-message" id="loginPasswordError"></span>
                            
                            <button type="submit">Login</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script>
        // Firebase configuration (unchanged)
        const firebaseConfig = {
            apiKey: "AIzaSyDNp5EX5oKWWIFWjQ5o5e5MnaVZTgFVLwo",
            authDomain: "midnightmathscape-e8e70.firebaseapp.com",
            databaseURL: "https://midnightmathscape-e8e70-default-rtdb.firebaseio.com",
            projectId: "midnightmathscape-e8e70",
            storageBucket: "midnightmathscape-e8e70.firebasestorage.app",
            messagingSenderId: "643428213528",
            appId: "1:643428213528:web:e14dfea52725d1b647746d",
            measurementId: "G-FTYBFHGQ4T"
        };

        // Initialize Firebase (unchanged)
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('loginFormElement');

            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                // Clear previous errors
                document.getElementById('loginEmailError').textContent = '';
                document.getElementById('loginPasswordError').textContent = '';

                try {
                    // Special-case: admin@stmichael.com -> settingsPage.html
                    if (email === 'admin@stmichael.com' && password === '12345') {
                        await auth.signInWithEmailAndPassword(email, password).catch(()=>{});
                        window.location.href = 'settingsPage.html';
                        return;
                    }

                    // Existing special-case: admin@stmichael.edu.ph -> accSecSetup.html
                    if (email === 'admin@stmichael.edu.ph' && password === '12345') {
                        const userCredential = await auth.signInWithEmailAndPassword(email, password);
                        window.location.href = 'accSecSetup.html';
                        return;
                    }

                    // Regular teacher login
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);

                    // Check if user is admin in Firestore (graceful fallback if offline)
                    try {
                        const userDoc = await db.collection('users').doc(userCredential.user.uid).get();
                        if (userDoc.exists && userDoc.data().role === 'admin') {
                            // route admin users: specific email goes to settingsPage, others to accSecSetup
                            if (email === 'admin@stmichael.com') {
                                window.location.href = 'settingsPage.html';
                            } else {
                                window.location.href = 'accSecSetup.html';
                            }
                        } else {
                            window.location.href = 'studentList.html';
                        }
                    } catch (err) {
                        console.warn('Firestore lookup failed, proceeding with fallback navigation:', err);
                        // fallback by email
                        if (email === 'admin@stmichael.com') {
                            window.location.href = 'settingsPage.html';
                        } else if (email === 'admin@stmichael.edu.ph') {
                            window.location.href = 'accSecSetup.html';
                        } else {
                            window.location.href = 'studentList.html';
                        }
                    }
                } catch (error) {
                    if (error.code === 'auth/user-not-found') {
                        document.getElementById('loginEmailError').textContent = 'User not found';
                    } else if (error.code === 'auth/wrong-password') {
                        document.getElementById('loginPasswordError').textContent = 'Incorrect password';
                    } else {
                        alert('Login error: ' + error.message);
                    }
                }
            });
        });
    </script>
</body>
</html>