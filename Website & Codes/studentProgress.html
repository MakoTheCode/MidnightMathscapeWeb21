<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Student Progress</title>
  <link rel="stylesheet" href="dashboard.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --color-primary: #8A1532; }
    body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:0; color:#222; }

    .status-active { color: #27ae60; font-weight: 500; }
    .status-inactive { color: #e74c3c; font-weight: 500; }
    .status-na { color: #7f7f7f; font-weight: 500; font-style: italic; }

    .controls { display: flex; align-items: center; gap: 20px; margin: 20px 0; flex-wrap: wrap; }

    .inner-grid { display:grid; grid-template-columns: 1fr 1fr 1fr 0.6fr 1fr; gap:12px; align-items:center; width:100%; }

    .data-container{ background:transparent;border-radius:10px;padding:18px;}
    .data-header,
    .student-item { display: grid; grid-template-columns: 1fr 1fr 1fr 0.6fr 1fr; gap: 15px; align-items: center; text-align: left; }
    .data-header { background: #f8f8f8; font-weight: 600; padding: 12px; border-radius: 8px; margin-bottom: 10px; cursor: default; }

    /* card header style (clickable) */
    .data-header { cursor:pointer; padding:12px; border-radius:8px; margin:8px 0; background:#fff; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 4px rgba(0,0,0,0.05); transition:0.12s; }
    .data-header.open { background:#fefefe; }
    .data-header i { transition: transform 0.18s; }
    .data-header.open i { transform: rotate(90deg); }

    .student-list{ padding:6px; max-height:55vh; overflow:auto }

    .student-body { display:none; padding:14px; background:#fff; border-radius:8px; margin-bottom:12px; box-shadow:0 2px 6px rgba(0,0,0,0.03); }
    .student-body .row { display:flex; gap:12px; align-items:center; }
    .student-body .meta { color:#555; font-size:0.95rem; }
    .student-body .actions { display:flex; gap:8px; justify-content:flex-end; }

    .btn { padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; border: none; }
    .btn-primary { background: var(--color-primary); color: #fff; }
    .btn-edit { background: var(--color-primary); color: #fff; }
    .btn-danger { background: #e74c3c; color: #fff; }

    @media (max-width: 700px) { .inner-grid{ grid-template-columns: 1fr 1fr; } .student-body .row { flex-direction:column; align-items:flex-start; } }
  </style>
</head>
<body>
  <div class="container-wrap">
    <div class="-main">
      <div class="main-menu">
        <img src="images/profile logo.PNG" width="60" height="60" style="display:block;margin:0 auto 12px;">
              <p>Math teacher</p>
        <div class="main-section">
          <p>Main</p>
          <a id="studlist" href="studentList.html">Student List</a>
          <a id="studprog" href="studentProgress.html">Student Progress</a>
          <a id="evalcontrol" href="evalControl.html">Evaluation & Control</a>
          <a id="accsetup" href="accSecSetup.html">Account & Section Setup</a>
        </div>
        
      </div>
    </div>

    <div class="-side">
      <div class="top-bar">
        <div style="flex:1"></div>
        <div class="logout"><a href="mainWeb.html" id="logoutBtn">Logout</a><i class="fas fa-sign-out-alt"></i></div>
      </div>

      <div class="dash-window" style="padding:20px;">
        <div class="header-title"><h1 style="margin:0 0 12px">Student Progress</h1></div>

        <div class="controls">
          <div>
            <label for="sectionSelect">Section:</label>
            <select id="sectionSelect" style="padding:8px;border-radius:6px;border:1px solid #ddd;min-width:220px;"></select>
          </div>
          <div>
            <label style="visibility:hidden">Export</label>
            <button id="exportProgressBtn" class="btn btn-outline-secondary" style="margin-left:8px;padding:6px 10px;">Export StudentsProgress CSV</button>
          </div>
          <div style="flex:1"></div>
        </div>

        <div class="data-container">
          <div class="total-students" id="totalStudents" style="font-weight:600;margin-bottom:12px;color:var(--color-primary)">Total Students: 0</div>

          <div class="data-header labels" aria-hidden="true" style="cursor:default;">
            <div class="inner-grid">
              <div style="font-weight:700">Student ID</div>
              <div style="font-weight:700">Last Name</div>
              <div style="font-weight:700">First Name</div>
              <div style="font-weight:700">M.I.</div>
              <div style="font-weight:700">Progress</div>
            </div>
          </div>

          <div class="student-list" id="studentList">
            <div class="loading"><i class="fas fa-spinner fa-spin"></i> Select a section to view students...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Modal -->
  <div class="modal fade" id="progressModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Student Progress</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="progressStudentInfo" style="margin-bottom:8px;font-weight:600"></div>

          <div id="chaptersContainer"></div>

          <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px;">
            <button id="saveProgressBtn" class="btn btn-primary">Save Progress</button>
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBkmM4hueT7PlnvV8FeRdp8g4rk0qQQrn4",
      authDomain: "midnightmathscape.firebaseapp.com",
      databaseURL: "https://midnightmathscape-e8e70-default-rtdb.firebaseio.com/",
      projectId: "midnightmathscape",
      storageBucket: "midnightmathscape.appspot.com",
      messagingSenderId: "1038485290511",
      appId: "1:1038485290511:web:c8aa78fbcd5266b706ed7a",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentSections = [];
    let currentStudents = [];
    let credStore = {};
    let activeStudentId = null;
    const progressModalEl = document.getElementById('progressModal');
    let progressModal = null;

    // Helper: extract percent from an attempt object (used for merging attempts into progress)
    function getAttemptPercentObj(attemptObj, normChapter){
      if(!attemptObj) return null;
      if(attemptObj.progress !== undefined){
        if(typeof attemptObj.progress === 'number') return attemptObj.progress;
        if(attemptObj.progress && typeof attemptObj.progress === 'object' && attemptObj.progress[normChapter] !== undefined){
          const v = attemptObj.progress[normChapter];
          return (typeof v === 'number') ? v : (v === true ? 100 : 0);
        }
      }
      if(attemptObj.percentage !== undefined) return Number(attemptObj.percentage);
      if(attemptObj.percent !== undefined) return Number(attemptObj.percent);
      if(attemptObj.score !== undefined && attemptObj.total !== undefined && Number(attemptObj.total) > 0){
        return Math.round((Number(attemptObj.score)/Number(attemptObj.total))*100);
      }
      if(attemptObj.keysFound !== undefined && attemptObj.keysNeeded !== undefined && Number(attemptObj.keysNeeded) > 0){
        return Math.round((Number(attemptObj.keysFound)/Number(attemptObj.keysNeeded))*100);
      }
      if(attemptObj.score !== undefined){ const s = Number(attemptObj.score); if(!Number.isNaN(s)) return s; }
      return null;
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      progressModal = new bootstrap.Modal(progressModalEl);
      loadSections();
      document.getElementById('sectionSelect').addEventListener('change', e=>{
        const sec = e.target.value; if(sec) loadStudents(sec); else { document.getElementById('studentList').innerHTML = '<div class="loading">Select a section...</div>'; document.getElementById('totalStudents').textContent='Total Students: 0'; }
      });
      document.getElementById('saveProgressBtn').addEventListener('click', saveProgress);

      // When modal hides, remove chevron state
      progressModalEl.addEventListener('hidden.bs.modal', ()=>{
        document.querySelectorAll('.chev').forEach(c=>c.classList.remove('open'));
      });
    });

    async function loadSections(){
      const snap = await db.ref('SectionList').once('value');
      const data = snap.val()||{};
      currentSections = Object.keys(data).map(id=>({ id, name: data[id].name||id }));
      const sel = document.getElementById('sectionSelect'); sel.innerHTML='<option value="">Select a section</option>';
      currentSections.forEach(s=>{ const o = document.createElement('option'); o.value=s.id; o.textContent=s.name; sel.appendChild(o); });
    }

    async function loadStudents(sectionId){
      const listEl = document.getElementById('studentList');
      listEl.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading students...</div>';
      // also fetch StudentsProgress so we can compute progress from attempts when progress node is missing or lower
      const [studSnap, credSnap, progSnap, studentsProgressSnap] = await Promise.all([
        db.ref('StudentAccount').once('value'),
        db.ref('Cridentials').once('value'),
        db.ref('progress').once('value'),
        db.ref('StudentsProgress').once('value')
      ]);
      const studs = studSnap.val()||{};
      const creds = credSnap.val()||{};
      const progs = progSnap.val()||{};
      const allAttempts = studentsProgressSnap.val()||{};
      credStore = creds;
      currentStudents = [];

      for(const id of Object.keys(studs)){
        const s = studs[id]||{};
        const c = creds[id];
        if((c && c.sectionId===sectionId) || (!c && sectionId)){
          // progress node may be keyed by internal id or by studentNumber in credentials
          let progressNode = progs[id] || {};
          const altKey = c && (c.studentNumber || c.studentId || c.studentNo);
          if((!progressNode || Object.keys(progressNode).length === 0) && altKey){ progressNode = progs[altKey] || {}; }

          // merge attempts: prefer highest percent between progress node and attempts for each chapter
          const mergedProgress = { ...(progressNode || {}) };
          const studentAttempts = allAttempts[id] || (altKey ? allAttempts[altKey] : null) || {};
          for(const rawChap of Object.keys(studentAttempts || {})){
            const norm = normalizeChapterKey(rawChap);
            if(!norm) continue;
            const group = studentAttempts[rawChap] || {};
            // find best percent among attempts in this raw chapter
            let best = null;
            for(const aid of Object.keys(group)){
              const p = getAttemptPercentObj(group[aid], norm);
              if(p !== null && (!Number.isNaN(p)) && (best === null || p > best)) best = p;
            }
            if(best !== null){
              // store only if better than progressNode value or if progress node has no value
              const existing = mergedProgress[norm];
              const existingVal = (existing===undefined) ? null : (typeof existing === 'number' ? existing : (existing===true?100:0));
              if(existingVal === null || best > existingVal) mergedProgress[norm] = best;
            }
          }

          // Use the StudentAccount key as canonical studentId (preserves leading zeros like '0404')
          // normalize to lowercase keys (firstname, lastname, middleinitial) while remaining tolerant of legacy camelCase in DB
          currentStudents.push({ id, studentId: id, lastname: s.lastname || s.lastName || '', firstname: s.firstname || s.firstName || '', middleinitial: s.middleinitial || s.middleInitial || '', progress: mergedProgress });
         }
       }
 
  currentStudents.sort((a,b)=> (a.lastname||'').localeCompare(b.lastname||''));
   renderStudents(currentStudents);
     }

    function renderStudents(students){
      const listEl = document.getElementById('studentList');
      if(!students.length){ listEl.innerHTML='<div class="no-students">No students found.</div>'; document.getElementById('totalStudents').textContent='Total Students: 0'; return; }
      listEl.innerHTML='';
      students.forEach(s=>{
        const header = document.createElement('div'); header.className='data-header';
        // compute initial overall progress from progress node
        const initialOverall = calculateOverallProgress(s.progress || {});
        header.innerHTML = `
          <div class="inner-grid">
            <div style="font-weight:700">${escapeHtml(s.studentId)}</div>
            <div>${escapeHtml(s.lastname)}</div>
            <div>${escapeHtml(s.firstname)}</div>
            <div>${escapeHtml(formatMiddleInitial(s.middleinitial))}</div>
            <div style="width:180px;">
              <div id="header-pct-${s.id}" style="font-weight:700;text-align:right">${initialOverall}%</div>
              <div class="progress" style="height:8px"><div id="header-bar-${s.id}" class="progress-bar bg-info" role="progressbar" style="width:${initialOverall}%"></div></div>
            </div>
          </div>
          <i class="fa-solid fa-chevron-right"></i>
        `;

        const body = document.createElement('div'); body.className='student-body';
        // build progress bars inside body
        let bodyHtml = '<div class="row"><div class="meta"><strong>ID:</strong> ' + escapeHtml(s.studentId) + '</div><div style="flex:1"></div></div>';
        bodyHtml += '<div style="margin-top:8px;">';
        for(let i=1;i<=12;i++){
          const key = 'chapter'+i; const val = (s.progress && s.progress[key]!==undefined) ? (typeof s.progress[key]==='number' ? s.progress[key] : (s.progress[key]===true?100:0)) : 0;
          bodyHtml += `
            <div class="mb-2">
              <div class="d-flex justify-content-between"><div>Chapter ${i}</div><div style="min-width:48px;text-align:right">${val}%</div></div>
              <div class="progress" style="height:10px;"><div class="progress-bar bg-info" role="progressbar" style="width:${val}%" aria-valuenow="${val}" aria-valuemin="0" aria-valuemax="100"></div></div>
            </div>`;
        }
  // remove manual edit/delete; add attempts toggle area (attempts are shown inline)
  bodyHtml += `<div style="display:flex;justify-content:flex-end;gap:8px;margin-top:6px;"><button class="btn btn-outline-secondary btn-sm" data-toggle-attempts="${s.id}">Show Attempts</button></div>`;
  bodyHtml += `<div id="attempts-${s.id}" class="attempts-inline" style="display:none;margin-top:10px;"></div>`;
        bodyHtml += '</div>';
        body.innerHTML = bodyHtml;

        // wire header click to toggle
        header.addEventListener('click', ()=>{
          const open = header.classList.contains('open');
          document.querySelectorAll('.data-header').forEach(h=>h.classList.remove('open'));
          document.querySelectorAll('.student-body').forEach(b=>b.style.display='none');
          if(!open){ header.classList.add('open'); body.style.display='block'; }
        });

        listEl.appendChild(header);
        listEl.appendChild(body);
      });
      document.getElementById('totalStudents').textContent = `Total Students: ${students.length}`;
    }

    // delegated handler: toggle attempts inline when attempts button clicked
    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest && e.target.closest('[data-toggle-attempts]');
      if(!btn) return;
      const sid = btn.getAttribute('data-toggle-attempts');
      const container = document.getElementById('attempts-'+sid);
      if(!container) return;
      const isOpen = container.style.display !== 'none' && container.style.display !== '';
      if(isOpen){ container.style.display = 'none'; btn.textContent = 'Show Attempts'; return; }
      // open: fetch attempts and progress (one-time fetch, not realtime)
      btn.textContent = 'Hide Attempts';
      container.style.display = 'block';
      container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading attempts...</div>';
      await loadStudentProgressAndAttempts(sid, container);
    });

    // When modal hides, remove chevron state (keeps existing behavior)

    function calculateOverallProgress(progressObj){
      let total=0, count=0;
      for(let i=1;i<=12;i++){ const key='chapter'+i; const v = progressObj && progressObj[key]; if(v===undefined) continue; count++; if(typeof v==='number') total+=v; else if(v===true) total+=100; else total+=0; }
      if(count===0) return 0; return Math.round(total/count);
    }

    // Modal logic
    async function openProgressModal(studentId){
      activeStudentId = studentId;
      const stud = currentStudents.find(s=>s.id===studentId);
      if(!stud) return;
      document.getElementById('progressStudentInfo').textContent = `${stud.studentId} — ${stud.lastname}, ${stud.firstname} ${formatMiddleInitial(stud.middleinitial)}`;
      const cont = document.getElementById('chaptersContainer'); cont.innerHTML='';
      const prog = stud.progress || {};
      for(let i=1;i<=12;i++){
        const key = 'chapter'+i; const val = prog[key]===undefined? 0 : (typeof prog[key]==='number'? prog[key] : (prog[key]===true?100:0));
        const wrapper = document.createElement('div'); wrapper.className='mb-3';
        wrapper.innerHTML = `
          <div class="d-flex justify-content-between"><div>Chapter ${i}</div><div><input type="number" min="0" max="100" value="${val}" data-chapter="${i}" class="form-control form-control-sm" style="width:80px"></div></div>
          <div class="progress mt-2" style="height:12px"><div class="progress-bar bg-success" role="progressbar" style="width:${val}%" aria-valuenow="${val}" aria-valuemin="0" aria-valuemax="100"></div></div>
        `;
        cont.appendChild(wrapper);
        const input = wrapper.querySelector('input');
        input.addEventListener('input', (e)=>{ let v = parseInt(e.target.value)||0; if(v<0) v=0; if(v>100) v=100; e.target.value=v; const bar = wrapper.querySelector('.progress-bar'); bar.style.width = v + '%'; bar.setAttribute('aria-valuenow', v); });
      }

      // Attempts container
      const attemptsTitle = document.createElement('div'); attemptsTitle.style.marginTop = '12px'; attemptsTitle.innerHTML = '<h6>Attempts</h6>';
      cont.appendChild(attemptsTitle);
      const attemptsWrap = document.createElement('div'); attemptsWrap.id = 'attemptsContainer'; attemptsWrap.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading attempts...</div>';
      cont.appendChild(attemptsWrap);

      // load attempts from StudentsProgress node
      await loadStudentAttempts(studentId, attemptsWrap);

      progressModal.show();
    }

    // Load and render attempts for a student from StudentsProgress
    async function loadStudentAttempts(studentId, containerEl){
      try{
        const snap = await db.ref('StudentsProgress/' + studentId).once('value');
        const data = snap.val();
        containerEl.innerHTML = '';
        if(!data){ containerEl.innerHTML = '<div class="no-attempts">No attempts recorded for this student.</div>'; return; }

        // data shape: { rawChapterKey: { attemptId: { timeSpentSeconds, date, ... } } }
        const list = document.createElement('div'); list.style.display='flex'; list.style.flexDirection='column'; list.style.gap='8px';
        for(const rawChap of Object.keys(data).sort()){
          const chapterGroup = data[rawChap] || {};
          const norm = normalizeChapterKey(rawChap) || rawChap;
          const header = document.createElement('div'); header.style.fontWeight='700'; header.style.marginTop='6px'; header.textContent = `${rawChap} (${norm})`;
          list.appendChild(header);
          // list attempts for this chapter
          const attempts = document.createElement('div'); attempts.style.display='flex'; attempts.style.flexDirection='column'; attempts.style.gap='6px'; attempts.style.marginLeft='6px';
          for(const attemptId of Object.keys(chapterGroup).sort((a,b)=>a.localeCompare(b)).reverse()){
            const a = chapterGroup[attemptId] || {};
            const secs = Number(a.timeSpentSeconds) || 0;
            const hms = secondsToHMS(secs);
            const mins = Math.round(secs/60);
            const date = a.date || a.timestamp || ''; // various possible fields
            const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='8px';
            const left = document.createElement('div'); left.innerHTML = `<div><strong>Attempt ${escapeHtml(attemptId)}</strong> — ${escapeHtml(date)}</div><div style="font-size:0.9rem;color:#555">Time: ${hms} (${mins} mins)</div>`;
            const right = document.createElement('div');
            const viewBtn = document.createElement('button'); viewBtn.className='btn btn-sm btn-primary'; viewBtn.textContent='View';
            viewBtn.addEventListener('click', ()=> showAttemptDetails(studentId, rawChap, attemptId, a));
            right.appendChild(viewBtn);
            row.appendChild(left); row.appendChild(right);
            attempts.appendChild(row);
          }
          list.appendChild(attempts);
        }
        containerEl.appendChild(list);
        // details area
        const details = document.createElement('div'); details.id='attemptDetails'; details.style.marginTop='10px'; containerEl.appendChild(details);
      }catch(err){ console.error('loadStudentAttempts error', err); containerEl.innerHTML = '<div class="text-danger">Error loading attempts</div>'; }
    }

    // Show attempt details (object) in the modal attempts details area
    function showAttemptDetails(studentId, rawChap, attemptId, attemptObj){
      const details = document.getElementById('attemptDetails'); if(!details) return;
      details.innerHTML = '';
      const header = document.createElement('div'); header.style.fontWeight='700'; header.textContent = `Details for ${rawChap} — Attempt ${attemptId}`;
      details.appendChild(header);
      const info = document.createElement('pre'); info.style.background='#f8f9fa'; info.style.padding='10px'; info.style.borderRadius='6px'; info.style.overflow='auto'; info.style.maxHeight='220px';
      // show formatted JSON
      try{ info.textContent = JSON.stringify(attemptObj, null, 2); }catch(e){ info.textContent = String(attemptObj); }
      details.appendChild(info);
      // If attempt includes a 'progress' object with chapter keys, render progress bars
      if(attemptObj && typeof attemptObj === 'object' && attemptObj.progress){
        const progWrap = document.createElement('div'); progWrap.style.marginTop='8px';
        for(let i=1;i<=12;i++){ const k='chapter'+i; const v = attemptObj.progress[k]; const val = (v===undefined)?0:(typeof v==='number'?v:(v===true?100:0));
          const el = document.createElement('div'); el.style.marginBottom='6px'; el.innerHTML = `<div class="d-flex justify-content-between"><div>Chapter ${i}</div><div style="min-width:48px;text-align:right">${val}%</div></div><div class="progress" style="height:10px"><div class="progress-bar bg-info" role="progressbar" style="width:${val}%"></div></div>`;
          progWrap.appendChild(el);
        }
        details.appendChild(progWrap);
      }
      // Scroll details into view inside modal
      details.scrollIntoView({ behavior:'smooth', block:'nearest' });
    }

    // Fetch student's Progress and StudentsProgress and render in provided container
    async function loadStudentProgressAndAttempts(studentId, containerEl){
      try{
        // Try progress keyed by internal id, then try credential studentNumber if available
        let progSnap = await db.ref('progress/' + studentId).once('value');
        let prog = progSnap.val() || {};
        if((!prog || Object.keys(prog).length===0) && credStore[studentId] && (credStore[studentId].studentNumber || credStore[studentId].studentId || credStore[studentId].studentNo)){
          const alt = credStore[studentId].studentNumber || credStore[studentId].studentId || credStore[studentId].studentNo;
          const altSnap = await db.ref('progress/' + alt).once('value');
          const altVal = altSnap.val() || {};
          if(altVal && Object.keys(altVal).length>0) prog = altVal;
        }
        const attemptsSnap = await db.ref('StudentsProgress/' + studentId).once('value');
        const attempts = attemptsSnap.val() || {};
        // Aggregate all attempts by normalized chapter
        const attemptsByNorm = {}; // chapterX -> array of {id, rawChap, attemptId, obj}
        for(const rawChap of Object.keys(attempts||{})){
          const norm = normalizeChapterKey(rawChap) || rawChap;
          attemptsByNorm[norm] = attemptsByNorm[norm] || [];
          const group = attempts[rawChap] || {};
          for(const aid of Object.keys(group)){
            attemptsByNorm[norm].push({ rawChap, attemptId: aid, obj: group[aid] });
          }
        }

        // Determine highest percent per normalized chapter
        const highestPercent = {}; // chapterX -> percent
        for(const norm of Object.keys(attemptsByNorm)){
          const arr = attemptsByNorm[norm];
          let best = -Infinity; let bestEntry = null;
          arr.forEach(it=>{ const p = getAttemptPercent(it.obj, norm); if(p!==null && !Number.isNaN(p) && p>best){ best = p; bestEntry = it; } });
          if(bestEntry) highestPercent[norm] = { percent: best, entry: bestEntry };
        }
        // Helper: extract percent from attempt object
        function getAttemptPercent(attemptObj, normChapter){
          if(!attemptObj) return null;
          // prefer explicit progress value
          if(attemptObj.progress !== undefined){
            // if progress is a number (overall percent)
            if(typeof attemptObj.progress === 'number') return attemptObj.progress;
            // if progress is an object keyed by chapters
            if(attemptObj.progress && typeof attemptObj.progress === 'object' && attemptObj.progress[normChapter] !== undefined){
              const v = attemptObj.progress[normChapter];
              return (typeof v === 'number') ? v : (v === true ? 100 : 0);
            }
          }
          if(attemptObj.percentage !== undefined) return Number(attemptObj.percentage);
          if(attemptObj.percent !== undefined) return Number(attemptObj.percent);
          if(attemptObj.score !== undefined && attemptObj.total !== undefined && Number(attemptObj.total) > 0){
            return Math.round((Number(attemptObj.score)/Number(attemptObj.total))*100);
          }
          if(attemptObj.keysFound !== undefined && attemptObj.keysNeeded !== undefined && Number(attemptObj.keysNeeded) > 0){
            return Math.round((Number(attemptObj.keysFound)/Number(attemptObj.keysNeeded))*100);
          }
          // fallback: if score looks like 0-100
          if(attemptObj.score !== undefined){ const s = Number(attemptObj.score); if(!Number.isNaN(s)) return s; }
          return null;
        }

        // Helper: pick latest attempt from a group object (attemptId -> attemptObj)
        function pickLatestAttempt(group){
          let bestId = null; let bestObj = null; let bestTs = -Infinity;
          for(const aid of Object.keys(group||{})){
            const a = group[aid] || {};
            let ts = -Infinity;
            if(a.timestamp !== undefined && !Number.isNaN(Number(a.timestamp))){ ts = Number(a.timestamp); }
            else if(a.timeStamp !== undefined && !Number.isNaN(Number(a.timeStamp))){ ts = Number(a.timeStamp); }
            else if(a.date){ const p = Date.parse(a.date); if(!Number.isNaN(p)) ts = p; }
            // fallback: use attempt id ordering by lexical (attempt ids often incremental); treat higher as newer
            if(!isFinite(ts)) ts = aid.split(/\D+/).map(n=>Number(n)||0).reduce((s,v)=>s*1000+v,0);
            if(ts > bestTs){ bestTs = ts; bestId = aid; bestObj = a; }
          }
          return { id: bestId, obj: bestObj, ts: bestTs };
        }

        // (previous logic removed) attempts are aggregated into attemptsByNorm and highestPercent below

        // render per-chapter dropdown + progress bar (choose which attempt or progress node to display)
        const progWrap = document.createElement('div'); progWrap.style.display='flex'; progWrap.style.flexDirection='column'; progWrap.style.gap='12px';
        for(let i=1;i<=12;i++){
          const rawChapName = Object.keys(attempts).find(rc => normalizeChapterKey(rc) === 'chapter'+i) || ('chapter '+i);
          const k='chapter'+i;
          // gather options: progress node value (if any) and all attempts under normalized chapter
          const optionList = [];
          const progVal = (prog[k]===undefined ? null : (typeof prog[k] === 'number' ? prog[k] : (prog[k] === true ? 100 : 0)));
          const arr = attemptsByNorm[k] || [];
          if (progVal !== null) { optionList.push({ label: 'Progress node value', percent: progVal, source: 'progress' }); }
          // sort attempts by best guess of time (latest first)
          arr.sort((a,b)=>{ const pa = pickLatestAttempt({[a.attemptId]:a.obj}); const pb = pickLatestAttempt({[b.attemptId]:b.obj}); return (pb && pb.ts || 0) - (pa && pa.ts || 0); });
          arr.forEach(it=>{ const aobj = it.obj || {}; const pct = getAttemptPercent(aobj, k); optionList.push({ label: `Attempt ${it.attemptId} — ${aobj.date||aobj.timestamp||''}`, percent: (pct===null?0:pct), source: 'attempt', attemptId: it.attemptId, rawChap: it.rawChap }); });

          // determine default percent: prefer progress node, then highest attempt percent (if any)
          const highestOpt = optionList.reduce((best,o)=> (o.percent>=(best?.percent||-Infinity))?o:best, null);
          let defaultPct = Math.max( progVal || 0, (highestOpt && highestOpt.percent) || 0 );

          const chapterRow = document.createElement('div'); chapterRow.style.display='flex'; chapterRow.style.flexDirection='column';
          const top = document.createElement('div'); top.className='d-flex justify-content-between align-items-center';
          const title = document.createElement('div'); title.textContent = `Chapter ${i}`;
          // select dropdown
          const sel = document.createElement('select'); sel.className='form-select form-select-sm'; sel.style.width='320px'; sel.style.maxWidth='40%';
          sel.id = `select-${studentId}-${k}`;

          // add options - ensure there's always a selectable "current progress" option (avoids empty selection)
          if(optionList.length === 0){
            const o = document.createElement('option');
            o.value = JSON.stringify({ type: 'computed' });
            o.textContent = `Current progress — ${defaultPct}%`;
            o.dataset.percent = defaultPct;
            sel.appendChild(o);
          } else {
            // add a "Latest attempt" synthetic option when attempts exist
            if(optionList.some(o=>o.source==='attempt')){
              const latestOpt = optionList.find(o=>o.source==='attempt');
              const o = document.createElement('option');
              o.value = JSON.stringify({type:'attempt', id: latestOpt.attemptId, raw: latestOpt.rawChap});
              o.textContent = `Latest attempt — ${latestOpt.label} — ${latestOpt.percent}%`;
              o.dataset.percent = latestOpt.percent;
              sel.appendChild(o);
            }
            // add progress node option if present
            if(progVal !== null){
              const o = document.createElement('option');
              o.value = JSON.stringify({type:'progress'});
              o.textContent = `Progress node — ${progVal}%`;
              o.dataset.percent = progVal;
              sel.appendChild(o);
            }
            // add each attempt option
            optionList.filter(o=>o.source==='attempt').forEach(at => {
              const opt = document.createElement('option');
              opt.value = JSON.stringify({type:'attempt', id: at.attemptId, raw: at.rawChap});
              opt.textContent = `${at.label} — ${at.percent}%`;
              opt.dataset.percent = at.percent;
              sel.appendChild(opt);
            });
          }
          // initial selection: choose first option
          sel.selectedIndex = 0;

          top.appendChild(title); top.appendChild(sel);
          chapterRow.appendChild(top);

          const barWrap = document.createElement('div'); barWrap.style.marginTop='6px'; barWrap.innerHTML = `<div class="d-flex justify-content-between"><div></div><div style="min-width:48px;text-align:right" id="pct-${studentId}-${k}">${defaultPct}%</div></div><div class="progress" style="height:10px"><div id="bar-${studentId}-${k}" class="progress-bar bg-success" role="progressbar" style="width:${defaultPct}%"></div></div>`;
          chapterRow.appendChild(barWrap);

          // on change, update the bar and percent text
          sel.addEventListener('change', (e)=>{
            const chosen = e.target.options[e.target.selectedIndex]; const pct = Number(chosen.dataset.percent) || 0;
            const bar = document.getElementById(`bar-${studentId}-${k}`); const pctEl = document.getElementById(`pct-${studentId}-${k}`);
            if(bar) bar.style.width = pct + '%'; if(pctEl) pctEl.textContent = pct + '%';
            // update header overall progress (average of selected percentages)
            try{
              let sum=0,count=0;
              for(let j=1;j<=12;j++){ const el = document.getElementById(`pct-${studentId}-chapter${j}`); if(el){ const num = Number(el.textContent.replace('%',''))||0; sum += num; count++; } }
              const avg = count? Math.round(sum/count) : 0;
              const headerBar = document.getElementById(`header-bar-${studentId}`); const headerPct = document.getElementById(`header-pct-${studentId}`);
              if(headerBar) headerBar.style.width = avg + '%'; if(headerPct) headerPct.textContent = avg + '%';
            }catch(e){ console.warn(e); }
          });

          progWrap.appendChild(chapterRow);
        }
        containerEl.innerHTML = '<div style="font-weight:700;margin-bottom:6px">Current Progress (choose attempt to view)</div>';
        containerEl.appendChild(progWrap);

        // render attempts below
        const attemptsTitle = document.createElement('div'); attemptsTitle.style.marginTop='8px'; attemptsTitle.style.fontWeight='700'; attemptsTitle.textContent = 'Attempts'; containerEl.appendChild(attemptsTitle);
        if(Object.keys(attempts).length === 0){ const n = document.createElement('div'); n.className='no-attempts'; n.textContent='No attempts recorded.'; containerEl.appendChild(n); return; }

        for(const rawChap of Object.keys(attempts).sort()){
          const norm = normalizeChapterKey(rawChap) || rawChap;
          const chHeader = document.createElement('div'); chHeader.style.marginTop='6px'; chHeader.style.fontWeight='600'; chHeader.textContent = `${rawChap} (${norm})`;
          containerEl.appendChild(chHeader);
          const group = attempts[rawChap] || {};
          for(const attemptId of Object.keys(group).sort((a,b)=>a.localeCompare(b)).reverse()){
            const a = group[attemptId] || {};
            const secs = Number(a.timeSpentSeconds) || 0; const hms = secondsToHMS(secs); const mins = Math.round(secs/60);
            const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.margin='6px 0';
            row.innerHTML = `<div><strong>Attempt ${escapeHtml(attemptId)}</strong> — ${escapeHtml(a.date||a.timestamp||'')}</div><div style="text-align:right">${hms} (${mins} mins) <button class="btn btn-sm btn-outline-primary ms-2">View</button></div>`;
            // attach view handler
            row.querySelector('button').addEventListener('click', ()=> showAttemptDetails(studentId, rawChap, attemptId, a));
            containerEl.appendChild(row);
          }
        }

  }catch(err){ console.error('loadStudentProgressAndAttempts error', err); containerEl.innerHTML = `<div class="text-danger">Error loading data: ${escapeHtml(err && err.message ? err.message : String(err))}</div><pre style="max-height:200px;overflow:auto">${escapeHtml(err && err.stack ? err.stack : '')}</pre>`; }
    }

    async function saveProgress(){
      if(!activeStudentId) return;
      const cont = document.getElementById('chaptersContainer');
      const inputs = cont.querySelectorAll('input[data-chapter]');
      const updates = {};
      inputs.forEach(inp=>{ const ch = inp.getAttribute('data-chapter'); const v = parseInt(inp.value)||0; updates['chapter'+ch] = v; });
      try{
  await db.ref('progress/' + activeStudentId).update(updates);
        const stud = currentStudents.find(s=>s.id===activeStudentId);
        if(stud){ stud.progress = { ...(stud.progress||{}), ...updates }; renderStudents(currentStudents); }
        progressModal.hide();
      }catch(err){ console.error('saveProgress error', err); alert('Error saving progress'); }
    }

    function escapeHtml(str){ if(str===undefined||str===null) return ''; return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
    function formatMiddleInitial(mi){ if(!mi) return ''; mi = String(mi).trim(); if(!mi) return ''; return mi.charAt(0).toUpperCase() + '.'; }

    // --- StudentsProgress aggregation & export ---
    function normalizeChapterKey(raw){
      if(!raw) return null;
      const m = String(raw).match(/(\d{1,2})/);
      if(!m) return null;
      return 'chapter' + parseInt(m[1],10);
    }

    function aggregateTimeSpent(studentsProgress){
      const out = {};
      for(const studentId of Object.keys(studentsProgress||{})){
        const chapters = studentsProgress[studentId] || {};
        out[studentId] = {};
        let studentTotal = 0;
        for(const rawChap of Object.keys(chapters)){
          const norm = normalizeChapterKey(rawChap);
          if(!norm) continue;
          const attempts = chapters[rawChap] || {};
          let chapterTotal = 0;
          for(const attemptId of Object.keys(attempts)){
            const attempt = attempts[attemptId] || {};
            const t = attempt.timeSpentSeconds;
            const secs = (typeof t === 'number') ? t : (typeof t === 'string' && t.trim() !== '' ? Number(t) : 0);
            if(Number.isFinite(secs)) chapterTotal += secs;
          }
          out[studentId][norm] = (out[studentId][norm] || 0) + chapterTotal;
          studentTotal += chapterTotal;
        }
        out[studentId].__totalSeconds = studentTotal;
      }
      return out;
    }

    function toCsv(agg){
      const chapters = Array.from({length:12}, (_,i)=>'chapter'+(i+1));
      const lines = [];
      lines.push(['studentId', ...chapters, 'totalSeconds'].join(','));
      for(const sid of Object.keys(agg)){
        const row = [sid];
        for(const ch of chapters){ row.push(agg[sid][ch] || 0); }
        row.push(agg[sid].__totalSeconds || 0);
        lines.push(row.join(','));
      }
      return lines.join('\n');
    }

    function secondsToHMS(secs){ secs = Number(secs)||0; const h = Math.floor(secs/3600); const m = Math.floor((secs%3600)/60); const s = secs%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

    document.getElementById('exportProgressBtn').addEventListener('click', async ()=>{
      try{
        const base = (firebaseConfig && firebaseConfig.databaseURL) ? firebaseConfig.databaseURL : window.prompt('Enter DB URL','https://midnightmathscape-e8e70-default-rtdb.firebaseio.com/');
        if(!base) return alert('No DB URL provided');
        const url = (base.endsWith('/')? base.slice(0,-1) : base) + '/StudentsProgress.json';
        const resp = await fetch(url, { cache:'no-store' });
        if(!resp.ok) return alert('Failed to fetch StudentsProgress: ' + resp.status + ' ' + resp.statusText);
        const sp = await resp.json();
        if(!sp) return alert('StudentsProgress is empty or inaccessible');

        const agg = aggregateTimeSpent(sp);
        // console table with human-readable totals
        const rows = Object.keys(agg).map(sid=>{
          const r = { studentId: sid };
          for(let i=1;i<=12;i++) r['chapter'+i] = agg[sid]['chapter'+i] || 0;
          r.totalSeconds = agg[sid].__totalSeconds || 0;
          r.total_hms = secondsToHMS(r.totalSeconds);
          return r;
        });
        console.table(rows);

        const csv = toCsv(agg);
        console.log('\nCSV:\n');
        console.log(csv);

        // create download link
        try{
          const blob = new Blob([csv], { type: 'text/csv' });
          const href = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = href; a.download = 'students_time_by_chapter.csv'; a.textContent = 'Download StudentsProgress CSV';
          a.style.position='fixed'; a.style.right='12px'; a.style.bottom='12px'; a.style.zIndex=999999; a.className='btn btn-primary';
          document.body.appendChild(a);
          setTimeout(()=> a.click(), 100);
        }catch(err){ console.warn('Could not create download link', err.message); }

      }catch(err){ console.error('Export error', err); alert('Error exporting StudentsProgress: '+err.message); }
    });

    // Simple auth check - no account validation needed
firebase.auth().onAuthStateChanged((user) => {
    if (!user) {
        window.location.href = 'mainWeb.html';
    }
    // If user exists, they're already validated from mainWeb.html
});
  </script>
</body>
</html>




