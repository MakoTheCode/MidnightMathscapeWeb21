<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Dashboard</title>
  <link rel="stylesheet" href="dashboard.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --color-primary: #8A1532; }

    body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:0; color:#222; }

    .status-active { color: #27ae60; font-weight: 500; }
    .status-inactive { color: #e74c3c; font-weight: 500; }
    .status-na { color: #7f7f7f; font-weight: 500; font-style: italic; }

    .controls { display: flex; align-items: center; gap: 20px; margin: 20px 0; flex-wrap: wrap; }
    .controls .input-group,
    .controls .search-container { margin: 0; flex: 1; min-width: 250px; }

    .data-header,
    .student-item {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr 0.7fr;
      gap: 15px; align-items: center; text-align: left;
    }
   /* inner-grid used for labels and row content to ensure perfect column alignment
     now includes a dedicated column for Middle Initial (M.I.) */
   .inner-grid { display:grid; grid-template-columns: 1fr 1fr 1fr 0.6fr 1fr; gap:12px; align-items:center; width:100%; }
    .data-header { background: #f8f8f8; font-weight: 600; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
    .student-item { padding: 15px; border-bottom: 1px solid #eee; }
    .student-item:last-child { border-bottom: none; }

    .top-bar { display: flex; justify-content: flex-end; align-items: center; padding: 10px 20px; background: #fff; border-bottom: 1px solid #ddd; }
    .logout a { color: var(--color-primary); font-weight: 600; margin-right: 8px; text-decoration: none; }
    .logout i { color: var(--color-primary); }

    /* Buttons */
    .btn { padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; border: none; }
    .btn-primary { background: var(--color-primary); color: #fff; }
    .btn-edit { background: var(--color-primary); color: #fff; }
    .btn-edit:hover { background: #6c1027; }
    .btn-danger { background: #e74c3c; color: #fff; }
    .btn-secondary { background: #7f7f7f; color: #fff; }

    /* Modal */
    .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
    .modal-content {
      background: #fff;
      padding: 40px;
      border-radius: 12px;
      width: 850px;
      max-width: 95%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 2px 20px rgba(0,0,0,0.35);
      animation: fadeIn 0.25s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .modal-content h2 { margin: 0 0 12px 0; font-size: 1.25rem; }
    .modal-left { display: grid; gap: 10px; grid-template-columns: 1fr; }
    .modal-content label { font-weight: 600; display:block; margin-top: 10px; }
    .modal-content input, .modal-content select, .modal-content textarea {
      width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 5px;
      font-size: 0.95rem;
    }
    .show-pass { margin-top: 8px; display: flex; align-items: center; gap: 8px; font-size: 0.95rem; }

    /* Two-column grid for Cridentials */
    #credInputs { display: grid; grid-template-columns: 1fr 1fr; gap: 12px 20px; margin-top: 10px; }
    #credInputs label { margin-top: 0; font-weight: 600; }

    /* Responsive adjustments */
    @media (max-width: 960px) {
      .modal-content { width: 95%; padding: 24px; }
      .data-header, .student-item { grid-template-columns: 1fr 1fr 1fr 1fr; } /* action will wrap */
      #credInputs { grid-template-columns: 1fr; }
    }
    /* Student card layout — evalControl-like header + collapsible body */
  .data-header { cursor:pointer; padding:12px; border-radius:8px; margin:8px 0; background:#fff; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 4px rgba(0,0,0,0.05); transition:0.12s; }
    .data-header.open { background:#fefefe; }
    .data-header i { transition: transform 0.18s; }
    .data-header.open i { transform: rotate(90deg); }

    .student-body { display:none; padding:14px; background:#fff; border-radius:8px; margin-bottom:12px; box-shadow:0 2px 6px rgba(0,0,0,0.03); }
    .student-body .row { display:flex; gap:12px; align-items:center; }
    .student-body .meta { color:#555; font-size:0.95rem; }
    .student-body .actions { display:flex; gap:8px; justify-content:flex-end; }
    .student-list { padding: 6px; }

    @media (max-width: 700px) {
      .data-header { flex-direction:row; }
      .inner-grid { grid-template-columns: 1fr 1fr; }
      .student-body .row { flex-direction:column; align-items:flex-start; }
    }
  </style>
</head>
<body>
  <div class="container-wrap">
    <div class="-main">
      <div class="main-menu">
        <img id="profileImage" src="Website & Codes\images\profile logo.PNG" alt="profile" style="width:50px;height:50px;border-radius:50%;display:block;margin:0 auto 12px;">
             <p>Math teacher</p>
        <div class="main-section">
          <p>Main</p>
          <a id="studlist" href="studentList.html">Student List</a>
          <a id="studprog" href="studentProgress.html">Student Progress</a>
          <a id="evalcontrol" href="evalControl.html">Evaluation & Control</a>
          <a id="accsetup" href="accSecSetup.html">Account & Section Setup</a>
        </div>
        <div class="settings-section">
          <p>Settings</p>
          <a id="settings" href="settingsPage.html">Account Settings</a>
        </div>
      </div>
    </div>

    <div class="-side">
      <div class="top-bar">
        <div class="logout">
          <a href="mainWeb.html" id="logoutBtn">Logout</a>
          <i class="fas fa-sign-out-alt"></i>
        </div>
      </div>

      <div class="dash-window" style="padding:20px;">
        <div class="header-title"><h1 style="margin:0 0 12px">Student List</h1></div>

        <div class="controls">
          <div class="input-group">
            <label for="sectionSelect">Section:</label>
            <select name="sectionSelect" id="sectionSelect">
              <option value="">Loading sections...</option>
            </select>
          </div>
          <div class="search-container" style="position:relative;">
            <i class="fas fa-search" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#888"></i>
            <input type="search" id="searchInput" placeholder="Search students by name or ID..." style="padding-left:36px;">
          </div>
        </div>

        <div class="data-container" style="background:#fff;border-radius:10px;padding:18px;box-shadow:0 2px 6px rgba(0,0,0,0.06);">
          <div class="total-students" id="totalStudents" style="font-weight:600;margin-bottom:12px;color:var(--color-primary)">Total Students: 0</div>
          <div class="data-header labels" aria-hidden="true" style="cursor:default;">
            <div class="inner-grid">
              <div style="font-weight:700">Student ID</div>
              <div style="font-weight:700">Last Name</div>
              <div style="font-weight:700">First Name</div>
              <div style="font-weight:700">M.I.</div>
              <div style="font-weight:700">Account Status</div>
            </div>
          </div>
          <div class="student-list" id="studentList" style="max-height:50vh;overflow:auto;">
            <div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading students...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
    <div class="modal-content">
      <h2 id="editModalTitle">Edit Student</h2>

      <input type="hidden" id="editStudentId">

      <div style="display:grid;grid-template-columns:1fr 1fr 0.6fr;gap:14px;">
        <div>
          <label for="editFirstName">First Name</label>
          <input type="text" id="editFirstName" />
        </div>
        <div>
          <label for="editLastName">Last Name</label>
          <input type="text" id="editLastName" />
        </div>
        <div>
          <label for="editMiddleInitial">M.I.</label>
          <input type="text" id="editMiddleInitial" maxlength="2" placeholder="A." />
        </div>
      </div>

      <div style="margin-top:12px;">
        <label for="editPassword">Password</label>
        <input type="password" id="editPassword" />
        <div class="show-pass">
          <label for="togglePassword" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="togglePassword" style="margin:0;"> Show Password
          </label>
        </div>
      </div>

      <!-- All Cridentials fields (two-column) -->
      <div id="credFields" style="display:none; margin-top:18px;">
        <h3 style="margin:0 0 10px">Cridentials Info</h3>
        <div id="credInputs"></div>
      </div>

      <div class="modal-actions" style="margin-top:18px;display:flex;justify-content:space-between;">
        <div>
          <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-danger" onclick="deleteStudent()">Delete</button>
          <button class="btn btn-primary" onclick="saveStudent()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

  <script>
    // Firebase config (same as yours)
    const firebaseConfig = {
      apiKey: "AIzaSyBkmM4hueT7PlnvV8FeRdp8g4rk0qQQrn4",
      authDomain: "midnightmathscape.firebaseapp.com",
      databaseURL: "https://midnightmathscape-e8e70-default-rtdb.firebaseio.com/",
      projectId: "midnightmathscape",
      storageBucket: "midnightmathscape.appspot.com",
      messagingSenderId: "1038485290511",
      appId: "1:1038485290511:web:c8aa78fbcd5266b706ed7a",
      measurementId: "G-WXGW44QMRD"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentStudents = [];
    let currentSections = [];
    let editingStudent = null;
    let credStore = {}; // cached Cridentials object

    // Utility to normalize name / password keys (handles both naming conventions when reading)
    function readFirstName(stud) { return (stud && (stud.firstName || stud.firstname || stud.name || '')) || ''; }
    function readLastName(stud)  { return (stud && (stud.lastName || stud.lastname || '')) || ''; }
  function readPassword(stud)  { return (stud && (stud.pass || stud.password || stud.pwd || '')) || ''; }

    // When saving, write only the canonical camelCase keys to avoid duplication in DB
    function buildStudentUpdate(firstName, lastName, passVal, middleInitial) {
      const out = {
        firstName: firstName,
        lastName: lastName,
        pass: passVal
      };
      if (middleInitial) out.middleInitial = middleInitial;
      return out;
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadSections();
      document.getElementById('sectionSelect').addEventListener('change', function() {
        if (this.value) loadStudents(this.value);
        else {
          document.getElementById('studentList').innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Select a section to view students</div>';
          document.getElementById('totalStudents').textContent = 'Total Students: 0';
        }
      });
      document.getElementById('searchInput').addEventListener('input', e => filterStudents(e.target.value || ''));

      // password toggle
      document.getElementById('togglePassword').addEventListener('change', function(){
        const pf = document.getElementById('editPassword');
        pf.type = this.checked ? 'text' : 'password';
      });
    });

    async function loadSections() {
      try {
        const ref = db.ref('SectionList');
        const snap = await ref.once('value');
        const data = snap.val() || {};
        currentSections = Object.keys(data).map(id => ({ id, name: data[id].name || id }));
        const select = document.getElementById('sectionSelect');
        select.innerHTML = '<option value="">Select a section</option>';
        currentSections.forEach(s => {
          const opt = document.createElement('option'); opt.value = s.id; opt.textContent = s.name;
          select.appendChild(opt);
        });

        // optional: auto-select first section if none chosen
        if (currentSections.length > 0 && !select.value) {
          // don't auto-load; let user choose to avoid surprises
        }
      } catch (err) {
        console.error('loadSections error', err);
        document.getElementById('sectionSelect').innerHTML = '<option value="">Error loading</option>';
      }
    }

    async function loadStudents(sectionId) {
      const studentList = document.getElementById('studentList');
      studentList.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading students...</div>';
      try {
        const [studSnap, credSnap] = await Promise.all([
          db.ref('StudentAccount').once('value'),
          db.ref('Cridentials').once('value')
        ]);
        const studentsData = studSnap.val() || {};
        const credData = credSnap.val() || {};
        credStore = credData;
        currentStudents = [];

        // collect students that either have Cridentials with this sectionId OR don't have Cridentials but exist in StudentAccount
        for (const studId of Object.keys(studentsData)) {
          const stud = studentsData[studId] || {};
          const cred = credData[studId];
          // include record if cred exists and section matches; OR if there is no cred but we still want to list them for this section (you used logic earlier: include if (!cred && sectionId))
          if ((cred && cred.sectionId === sectionId) || (!cred && sectionId)) {
            currentStudents.push({
              id: studId,
              studentId: cred?.studentNumber || 'N/A',
              lastName: readLastName(stud),
              firstName: readFirstName(stud),
              pass: readPassword(stud),
              middleInitial: (stud && (stud.middleInitial || stud.middleinitial || '')) || '',
              status: cred?.status || 'N/A',
              hasCred: !!cred
            });
          }
        }

        // sort alphabetical by last then first
        currentStudents.sort((a,b)=>{
          const la = (a.lastName||'').toLowerCase();
          const lb = (b.lastName||'').toLowerCase();
          if (la < lb) return -1; if (la > lb) return 1;
          const fa = (a.firstName||'').toLowerCase();
          const fb = (b.firstName||'').toLowerCase();
          if (fa < fb) return -1; if (fa > fb) return 1;
          return 0;
        });

        renderStudents(currentStudents);
      } catch (err) {
        console.error('loadStudents error', err);
        studentList.innerHTML = '<div class="no-students">Error loading students</div>';
        document.getElementById('totalStudents').textContent = 'Total Students: 0';
      }
    }

    function renderStudents(students) {
      const studentList = document.getElementById('studentList');
      if (!students.length) {
        studentList.innerHTML = '<div class="no-students">No students found.</div>';
        document.getElementById('totalStudents').textContent = 'Total Students: 0';
        return;
      }
      studentList.innerHTML = '';
      students.forEach(s=>{
        let statusClass = 'status-na';
        if ((s.status||'').toLowerCase() === 'active') statusClass = 'status-active';
        if ((s.status||'').toLowerCase() === 'inactive') statusClass = 'status-inactive';

        // create card per student (similar to evalControl)
        // header (clickable)
        const header = document.createElement('div');
        header.className = 'data-header';
        // display fields in the same order as your table headings: Student ID | Last Name | First Name | Account Status
        header.innerHTML = `
          <div class="inner-grid">
            <div style="font-weight:700">${escapeHtml(s.studentId)}</div>
            <div>${escapeHtml(s.lastName)}</div>
            <div>${escapeHtml(s.firstName)}</div>
            <div>${escapeHtml(formatMiddleInitial(s.middleInitial))}</div>
            <div class="${statusClass}">${escapeHtml(s.status)}</div>
          </div>
          <i class="fa-solid fa-chevron-right"></i>
        `;

        // body (collapsible)
        const body = document.createElement('div');
        body.className = 'student-body';
        body.innerHTML = `
          <div class="row">
            <div class="meta"><strong>Status:</strong> <span class="${statusClass}">${escapeHtml(s.status)}</span></div>
            <div class="meta"><strong>ID:</strong> ${escapeHtml(s.studentId)}</div>
            <div style="flex:1"></div>
            <div class="actions">
              <button class="btn btn-danger" onclick="deleteStudentById('${s.id}')">Delete</button>
              <button class="btn btn-edit" onclick="openModal('${s.id}')"><i class="fas fa-pen"></i> Edit</button>
            </div>
          </div>
        `;

        studentList.appendChild(header);
        studentList.appendChild(body);

        header.addEventListener('click', () => {
          const open = header.classList.contains('open');
          document.querySelectorAll('.data-header').forEach(h=>h.classList.remove('open'));
          document.querySelectorAll('.student-body').forEach(b=>b.style.display='none');
          if(!open){ header.classList.add('open'); body.style.display='block'; }
        });
      });
      document.getElementById('totalStudents').textContent = `Total Students: ${students.length}`;
    }

    function filterStudents(term) {
      term = (term || '').toString().toLowerCase();
      if (!term) { renderStudents(currentStudents); document.getElementById('totalStudents').textContent = `Total Students: ${currentStudents.length}`; return; }
      const filtered = currentStudents.filter(s =>
        (s.studentId||'').toLowerCase().includes(term) ||
        (s.lastName||'').toLowerCase().includes(term) ||
        (s.firstName||'').toLowerCase().includes(term)
      );
      renderStudents(filtered);
      document.getElementById('totalStudents').textContent = `Total Students: ${filtered.length}`;
    }

    // Open modal and populate. Will show all Cridentials keys dynamically if present.
    function openModal(id) {
      const student = currentStudents.find(s => s.id === id);
      if (!student) return;
      editingStudent = student;
      document.getElementById('editStudentId').value = student.id;
  document.getElementById('editFirstName').value = student.firstName || '';
  document.getElementById('editLastName').value = student.lastName || '';
  document.getElementById('editMiddleInitial').value = student.middleInitial || '';
  document.getElementById('editPassword').value = student.pass || '';
      document.getElementById('togglePassword').checked = false;
      document.getElementById('editPassword').type = 'password';

      // Render Cridentials fields (two-column) dynamically
      const credDiv = document.getElementById('credFields');
      const credInputs = document.getElementById('credInputs');
      credInputs.innerHTML = '';
      if (student.hasCred) {
        credDiv.style.display = 'block';
        const cred = credStore[student.id] || {};
        // Render each key except sectionId (skip if you want). Show keys in a stable order: studentNumber, username, email, contactNumber, address, status, createdAt, ...rest
        const preferredOrder = ['studentNumber','username','email','contactNumber','address','status','createdAt'];
        const keys = new Set(Object.keys(cred));
        // Ensure preferred order first
        preferredOrder.forEach(k => { if (keys.has(k)) { renderCredField(k, cred[k], credInputs); keys.delete(k); }});
        // Render remaining keys alphabetically
        Array.from(keys).sort().forEach(k => {
          if (k === 'sectionId') return; // skip by default
          renderCredField(k, cred[k], credInputs);
        });
      } else {
        credDiv.style.display = 'none';
      }

      // show modal
      document.getElementById('editModal').style.display = 'flex';
    }

    // helper to render a single cred label+input inside the credInputs container
    function renderCredField(key, value, container) {
      const label = document.createElement('label');
      label.setAttribute('for', `cred_${key}`);
      label.textContent = prettifyKey(key);
      const input = document.createElement('input');
      input.type = 'text';
      input.id = `cred_${key}`;
      input.value = value === undefined || value === null ? '' : String(value);
      container.appendChild(label);
      container.appendChild(input);
    }

    function prettifyKey(k) {
      // simple prettifier: studentNumber -> Student Number
      return k.replace(/([A-Z])/g, ' $1')
              .replace(/_/g, ' ')
              .replace(/\b\w/g, c => c.toUpperCase());
    }

    function closeModal() {
      document.getElementById('editModal').style.display = 'none';
      editingStudent = null;
    }

    // Save student: updates StudentAccount (writes both key variants) and updates Cridentials (only keys that existed)
    async function saveStudent() {
      const id = document.getElementById('editStudentId').value;
      if (!id) return alert('No student selected.');

  const firstName = (document.getElementById('editFirstName').value || '').trim();
  const lastName = (document.getElementById('editLastName').value || '').trim();
  const middleInitial = (document.getElementById('editMiddleInitial').value || '').trim();
  const password = (document.getElementById('editPassword').value || '').trim();

      if (!firstName || !lastName) { alert('First name and last name required.'); return; }
      if (!password) { alert('Password cannot be empty.'); return; }

      // Confirm password change if it differs
      if ((editingStudent.pass || '') !== password) {
        if (!confirm('Are you sure you want to change password?')) return;
      }

      try {
        // update StudentAccount — write both naming variants so other parts of your system find the values
  const studUpdate = buildStudentUpdate(firstName, lastName, password);
  // include middleInitial in StudentAccount update
  if (middleInitial) studUpdate.middleInitial = middleInitial;
        await db.ref('StudentAccount/' + id).update(studUpdate);

        // if has Cridentials, update them: take each rendered cred_{key} field and update that key
        if (editingStudent.hasCred) {
          const cred = credStore[id] || {};
          const updates = {};
          for (const key of Object.keys(cred)) {
            if (key === 'sectionId') continue; // skip structural field unless you want to allow editing
            const el = document.getElementById(`cred_${key}`);
            if (el) updates[key] = el.value;
          }
          if (Object.keys(updates).length) {
            await db.ref('Cridentials/' + id).update(updates);
          }
        }

        alert('Student updated successfully!');
        closeModal();
        // reload list for current section
        const sec = document.getElementById('sectionSelect').value;
        if (sec) await loadStudents(sec);
      } catch (err) {
        console.error('saveStudent error', err);
        alert('Error saving student. Check console for details.');
      }
    }

    // Delete student + cridentials
    async function deleteStudent() {
      const id = document.getElementById('editStudentId').value;
      if (!id) return;
      if (!confirm('Are you sure you want to delete this student?')) return;
      try {
        await db.ref('StudentAccount/' + id).remove();
        await db.ref('Cridentials/' + id).remove();
        alert('Student deleted.');
        closeModal();
        const sec = document.getElementById('sectionSelect').value;
        if (sec) loadStudents(sec);
      } catch (err) {
        console.error('deleteStudent error', err);
        alert('Error deleting student.');
      }
    }

    // Delete helper for list view
    async function deleteStudentById(id){
      if(!id) return; if(!confirm('Delete this student?')) return;
      try{
        await db.ref('StudentAccount/' + id).remove();
        await db.ref('Cridentials/' + id).remove();
        const sec = document.getElementById('sectionSelect').value;
        if (sec) loadStudents(sec);
      }catch(err){ console.error('deleteStudentById error', err); alert('Error deleting student.'); }
    }

    // small escape for text inserted into innerHTML
    function escapeHtml(str) {
      if (str === undefined || str === null) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // format middle initial: 'A' -> 'A.' ; return empty string when falsy
    function formatMiddleInitial(mi){
      if(!mi) return '';
      mi = String(mi).trim();
      if(!mi) return '';
      // take first character only and uppercase
      const ch = mi.charAt(0).toUpperCase();
      return ch + '.';
    }
  </script>
</body>
</html>
