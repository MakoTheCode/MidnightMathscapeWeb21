<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Account & Section Setup</title>

<link rel="stylesheet" href="dashboard.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
/* --- Updated styles: improved card layout + modal --- */
#accsetup { color: white; font-weight: 600; }

.section-container {
  display: grid;
  grid-template-columns: repeat(2, minmax(280px, 1fr));
  gap: 18px;
  padding: 10px;
  max-height: 72vh;
  overflow-y: auto;
  box-sizing: border-box;
}

/* Make first card (create) span both columns if present */
.section-container > .card:first-child {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: transparent;
  box-shadow: none;
}

/* Card: use flexible layout and allow contents to wrap/shrink */
.section-card {
  background: #fff;
  border-radius: 12px;
  padding: 14px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.05);
  transition: transform .12s ease, box-shadow .12s ease;
  box-sizing: border-box;
  min-height: 120px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  overflow: hidden;
}
.section-card:hover { transform: translateY(-3px); box-shadow: 0 10px 24px rgba(0,0,0,0.08); }

/* Card top / title alignment fixes */
.card-top {
  display: flex;
  justify-content: space-between;
  gap: 12px;
  align-items: flex-start; /* keep actions top-aligned */
}
.card-top-left {
  flex: 1 1 auto; /* allow title area to grow/shrink */
  min-width: 0;   /* allow flexible children to wrap correctly */
  display: block; /* keep block for stacking if needed */
}

/* New inline title row so code sits to the right of title */
.title-row {
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Make title single-line with ellipsis so it won't push the code down */
.section-title {
  font-size: 1.25rem;
  color: #7e142a;
  margin: 0;
  font-weight: 800;
  line-height: 1.05;
  white-space: nowrap;            /* prevent wrapping */
  overflow: hidden;               /* clip overflow */

  min-width: 0;                   /* allow truncation inside flex */
}

/* Keep code small and on the same row */
.section-code {
  color: #7a7a7a;
  font-size: 0.82rem;
  margin-top: 0;                  /* remove top gap so it stays on same line */
  display: inline-block;
  white-space: nowrap;
  flex: 0 0 auto;
  text-transform: uppercase;
  letter-spacing: 0.6px;
}

/* Actions column stays compact */
.card-actions {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 6px;
  min-width: 92px;
  flex: 0 0 auto;
}

/* Icon buttons unchanged but ensure they don't force layout */
.icon-btn, .delete-btn {
  background: transparent;
  border: 0;
  padding: 6px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1rem;
  color: #7e142a;
}
.delete-btn { color: #d64f4f; }
.icon-btn:hover, .delete-btn:hover { background: rgba(126,20,42,0.06); }

/* Divider and schedule: aligned, schedule time can wrap */
.section-code-divider { height: 1px; background: #f3eaea; margin: 10px 0; border-radius: 2px; }
.schedule-list { padding: 4px 0 6px 0; font-size: 0.95rem; color: #333; }
.schedule-row { display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px dashed #f6f2f2; gap: 12px; }
.schedule-row:last-child { border-bottom:0; }

/* Day column fixed-ish, time column flexible and wraps */
.schedule-day { color:#666; flex: 0 0 110px; font-weight:600; font-size:0.92rem; white-space:normal; }
.schedule-time { color:#222; font-weight:600; text-align:right; flex: 1 1 auto; white-space:normal; word-break:break-word; }

/* Footer */
.card-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 8px;
  gap: 12px;
}
/* left / right groups inside footer for consistent alignment */
.card-footer .left { display: flex; align-items: center; gap: 12px; }
.card-footer .right { display: flex; align-items: center; gap: 12px; }

/* slightly bigger, fixed-width student count so it doesn't reflow other items */
.student-count {
  background: #f6f6f7;
  color: #333;
  padding: 8px 12px;
  border-radius: 14px;
  font-weight: 700;
  font-size: 0.95rem;
  min-width: 72px;
  text-align: center;
  box-shadow: inset 0 -1px 0 rgba(0,0,0,0.02);
}

/* ensure see-students is an inline-flex so icon and text vertically align */
.see-students {
  color: #7e142a;
  text-decoration: none;
  font-weight: 700;
  font-size: 0.95rem;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding-left: 4px;
}

/* Buttons */
.add-btn { background:#7e142a; color:#fff; border:0; padding:8px 10px; border-radius:8px; cursor:pointer; font-size:0.92rem; }
.add-btn:hover { background:#5a0d1a; }
.see-students { color:#7e142a; text-decoration:none; font-weight:700; font-size:0.92rem; margin-left:8px; }

/* Modal */
.account-modal { display:none; position:fixed; z-index:4000; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.45); align-items:center; justify-content:center; padding:20px; }
.account-modal .modal-content { background:white; width:100%; max-width:900px; border-radius:12px; padding:25px; box-shadow:0 8px 20px rgba(0,0,0,0.15); max-height:90vh; overflow:auto; }
.account-modal .close { font-size:24px; cursor:pointer; color:#6c757d; }
.account-modal .close:hover { color:#a72344; }
.account-modal .modal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:18px; }
.account-modal h2 { margin:0; font-size:1.5em; color:#8A1532; }
.account-modal .form-row { display:flex; gap:15px; margin-bottom:15px; }
.account-modal .form-group { flex:1; }
.account-modal .form-group label { display:block; margin-bottom:5px; font-weight:500; }
.account-modal .form-input { width:100%; padding:8px 12px; border:1px solid #ddd; border-radius:4px; box-sizing:border-box; }
.account-modal .save-question-btn { background:#8A1532; color:#fff; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; margin-left:10px; }
.account-modal .save-question-btn:hover { background:#501121; }
.account-modal .cancel-btn { background:#ddd; color:#333; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; }
.account-modal .cancel-btn:hover { background:#bbb; }

@media (max-width:700px){
  .section-card{ max-width:100%; }
  .card-top{flex-direction:column;align-items:flex-start;}
  .card-actions{align-items:flex-start;}
  .account-modal .form-row{flex-direction:column;}
}

/* create a scrollable box that contains the section cards */
.sections-box{
  background: transparent;
  border-radius: 12px;
  padding: 12px;;
  max-height: 520px;         /* height of the scrollable box */
  overflow-y: auto;          /* enable vertical scroll for cards only */
  box-sizing: border-box;
}

/* adjust grid so it grows inside the box (no own scrolling) */
.section-container{
  display: grid;
  grid-template-columns: repeat(2, minmax(280px, 1fr));
  gap: 18px;
  padding: 8px 4px;          /* keep inner spacing small */
  max-height: none;          /* allow container to expand inside sections-box */
  overflow: visible;
  box-sizing: border-box;
}

/* optionally show a subtle inner scrollbar padding so content doesn't butt against edges */
.sections-box::-webkit-scrollbar { width: 10px; }
.sections-box::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.06); border-radius:6px; }

/* Responsive overrides (append) */
@media (max-width:1200px){
  .section-container {
    grid-template-columns: repeat(2, minmax(260px, 1fr));
    gap: 16px;
  }
  .sections-box { padding: 18px; max-height: calc(100vh - 140px); }
  .section-card { min-height: 160px; padding: 16px; }
  .section-title { font-size: 1.35rem; }
}

@media (max-width:900px){
  /* single column layout for tablets / small laptops */
  .section-container { grid-template-columns: 1fr; }
  .section-container > .card:first-child { grid-column: auto; }
  .sections-box { padding: 14px; max-height: calc(100vh - 120px); }

  /* keep top row compact: allow title to wrap but keep code close */
  .card-top { align-items: center; gap: 10px; }
  .card-top-left { min-width: 0; }
  .title-row { display: flex; flex-direction: column; gap: 6px; }
  .section-title {
    white-space: normal;           /* allow wrapping on small screens */
    overflow: visible;
    text-overflow: unset;
    font-size: 1.15rem;
  }
  .section-code {
    display: block;
    margin-top: 4px;
    font-size: 0.85rem;
  }

  /* move action icons into a single row */
  .card-actions { flex-direction: row; gap: 10px; align-items: center; }

  /* tighten schedule and footer */
  .schedule-row { padding: 6px 0; font-size: 0.94rem; }
  .schedule-day { flex: 0 0 92px; }
  .schedule-time { min-width: 110px; text-align:right; }

  .student-count { font-size: 0.9rem; padding: 6px 10px; }
  .add-btn { padding: 8px 12px; font-size: 0.95rem; }
}

@media (max-width:480px){
  /* phones: compact spacing and sizes */
  .sections-box { padding: 10px; max-height: calc(100vh - 100px); }
  .section-card { padding: 12px; min-height: 120px; }
  .section-title { font-size: 1.05rem; }
  .section-code { font-size: 0.78rem; }

  /* schedule compact */
  .schedule-day { flex: 0 0 72px; font-size: 0.85rem; }
  .schedule-time { min-width: 90px; font-size: 0.9rem; text-align:right; }

  /* make buttons slightly larger tap targets */
  .add-btn, .save-question-btn { padding: 9px 12px; font-size: 0.95rem; }
  .icon-btn, .delete-btn { padding: 8px; }
}

/* Extra responsive improvements for small screens */
@media (max-width:600px) {
  /* Make section grid single-column and remove side paddings */
  .section-container { grid-template-columns: 1fr !important; gap:12px; }
  .sections-box { padding: 10px; max-height: none; }

  /* Cards should expand naturally and allow content to wrap */
  .section-card { padding: 12px; min-height: auto; }
  .card-top { flex-direction: column; align-items: flex-start; gap:8px; }
  .card-actions { flex-direction: row; gap:8px; align-items:center; width:100%; justify-content:space-between; }

  /* Make header action buttons wrap and be easy to tap */
  .section-container > .card:first-child { flex-direction: column; align-items:stretch; gap:8px; }
  #toggleCreateSection, #toggleImportBtn, #downloadTemplateBtn { width:100%; justify-content:center; }

  /* Modals: use bottom sheet style on phones for better UX */
  .account-modal { align-items: flex-end; padding:0; }
  .account-modal .modal-content { width:100%; max-width:100%; border-radius:12px 12px 0 0; margin:0; box-shadow: 0 -6px 30px rgba(0,0,0,0.18); max-height:90vh; overflow:auto; padding:16px; }

  /* Stack modal action buttons and make them full-width for touch */
  .account-modal .save-question-btn, .account-modal .cancel-btn, .account-modal .add-btn { width:100%; display:block; }
  .account-modal .form-row { flex-direction: column; }

  /* Improve table container and choose-modal for small screens */
  #chooseStudentModal .modal-content { padding:12px; }
  #chooseStudentModal table { width:100%; border-collapse:collapse; }
  #chooseStudentModal table thead th { font-size:0.95rem; }
  #chooseStudentModal tbody td { font-size:0.95rem; }
  #chooseStudentModal div[style*="overflow:auto"] { -webkit-overflow-scrolling: touch; }

  /* Increase tap targets for icon buttons */
  .icon-btn, .delete-btn, .add-btn { padding:12px; border-radius:10px; }

  /* Reduce card footer density */
  .card-footer { flex-direction: column; align-items:stretch; gap:10px; }
  .card-footer .right { justify-content:flex-end; }
}

/* Small tweak for very narrow phones */
@media (max-width:380px){
  .account-modal .modal-content { padding:12px 10px; }
  #toggleCreateSection i, #toggleImportBtn .chev { display:inline-block; }
}

/* Make Download Template button match site's maroon theme */
#downloadTemplateBtn {
  background: #7e142a !important;     /* primary maroon used across the UI */
  color: #fff !important;
  border: 0;
  padding: 8px 10px;
  border-radius: 8px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-weight: 700;
}
#downloadTemplateBtn i { color: #fff; }
#downloadTemplateBtn:hover { background: #501121 !important; }

/* Tweak Import chevron button to match theme */
#toggleImportBtn {
  color: #7e142a;
  background: transparent;
  border: 1px solid rgba(126,20,42,0.06);
  padding: 8px 10px;
  border-radius: 8px;
}
#toggleImportBtn .chev { color: #7e142a; }

/* Ensure batch action buttons remain consistent */
#batchChooseBtn, #batchUploadBtn {
  background: linear-gradient(#8A1532, #7e142a) !important;
  color: #fff !important;
  border-radius: 8px;
  padding: 8px 10px;
  border: 0;
}
#batchChooseBtn:hover, #batchUploadBtn:hover { background: #501121 !important; }

/* --- Existing styles continue --- */
#toggleCreateSection {
  color: #7e142a;
  background: transparent;
  border: 1px solid rgba(126,20,42,0.06);
  padding: 8px 10px;
  border-radius: 8px;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}
#toggleCreateSection .chev { color: #7e142a; }
#toggleCreateSection:hover { background: rgba(126,20,42,0.04); }
</style>
</head>
<body>
<div class="container-wrap">
  <div class="-main">
    <div class="main-menu">
      <img src="images/profile logo.PNG" width="60" height="60">
      <p>Math teacher</p>
      <div class="main-section">
        <p>Main</p>
        <a href="studentList.html">Student List</a>
        <a href="studentProgress.html">Student Progress</a>
        <a href="evalControl.html">Evaluation & Control</a>
        <a href="accSecSetup.html">Account & Section Setup</a>
      </div>
    </div>
  </div>

  <div class="-side">
    <div class="top-bar">
  <div style="flex:1"></div>
  <div class="logout" style="display:flex; align-items:center; gap:8px;">
    <!-- text link (keeps visible text) -->
    <a href="mainWeb.html" id="logoutLink" style="color:#333; text-decoration:none;">Logout</a>
    <!-- icon button you added — now clickable and accessible -->
    <button id="logoutBtn" class="icon-btn" title="Logout" aria-label="Logout" style="color:#333; background:transparent;border:0;padding:6px;cursor:pointer;">
      <i class="fas fa-sign-out-alt"></i>
    </button>
  </div>
    </div>

    <div class="dash-window">
      <div class="header-title"><h1>Account & Section Setup</h1></div>
      <div class="data-container">
        <p>Total Sections: <span id="totalSections">0</span></p>

        <div class="section-container">
          <div class="card" style="width:100%; max-width:920px; margin-bottom:20px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
              <div style="display:flex; align-items:center; gap:12px;">
                <button id="toggleCreateSection" aria-expanded="false">
                  <i class="fas fa-plus" aria-hidden="true"></i>
                  Create New Section
                  <span id="toggleIcon" class="chev" style="font-size:1.1em">▾</span>
                </button>
                <button id="toggleImportBtn" class="icon-btn" aria-expanded="false" style="font-weight:700;padding:8px 10px;border-radius:8px;">
                  Import via Excel <span class="chev" style="margin-left:6px">▾</span>
                </button>
                <!-- TEMPLATE DOWNLOAD BUTTON (placed beside Import) -->
                <button id="downloadTemplateBtn" class="add-btn" style="background:#1f7fb3;padding:8px 10px;border-radius:8px;">
                  <i class="fas fa-file-excel" style="margin-right:8px"></i> Download Template
                </button>
              </div>
            </div>

            <!-- hidden batch controls (toggle with chevron) -->
            <div id="batchControlsWrap" style="display:none; margin-top:12px; gap:10px; align-items:center; flex-wrap:wrap;">
              <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <label for="batchSectionSelect" style="font-weight:600;color:#501121;margin-right:6px;">Assign to:</label>
                <select id="batchSectionSelect" class="form-input" style="min-width:220px; max-width:320px;">
                  <option value="">Select section...</option>
                </select>
              </div>
              <div style="display:flex; align-items:center; gap:8px; margin-top:8px;">
                <input id="batchFileInput" type="file" accept=".xlsx,.xls,.csv" style="display:none">
                <button id="batchChooseBtn" class="add-btn" style="background:#6b1a33;padding:8px 10px;">Choose File</button>
                <button id="batchUploadBtn" class="add-btn" style="background:#7e142a;padding:8px 10px;">Upload</button>
              </div>
            </div>

            <!-- small status / filename -->
            <div id="batchStatus" style="margin-top:10px;color:#444;font-size:0.95rem;"></div>
          </div>
        </div>
        <!-- Create Section Modal -->
        <div class="section-modal account-modal" id="createSectionModal" style="display:none;">
          <div class="modal-content" style="max-width:760px;">
            <div class="modal-header">
              <h2 id="createSectionModalTitle">Add Section</h2>
              <span class="close" id="closeCreateSection">&times;</span>
            </div>
            <div class="section-form">
              <div class="form-row">
                <div class="form-group">
                  <label>Section Code</label>
                  <input type="text" id="newSectionCode" class="form-input" placeholder="e.g. KAM01901">
                </div>
                <div class="form-group">
                  <label>Grade Level</label>
                  <input type="number" id="newGradeLevel" class="form-input" min="1" max="12" placeholder="6">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group" style="flex:2">
                  <label>Section Name</label>
                  <input type="text" id="newSectionName" class="form-input" placeholder="e.g. Kamagong">
                </div>
              </div>
              <div style="margin-top:8px;">
                <label style="display:block; margin-bottom:6px;">Schedule</label>
                <div class="form-row">
                  <div class="form-group" style="max-width:180px;">
                    <label>Day</label>
                    <select id="scheduleDay" class="form-input">
                      <option>Monday</option>
                      <option>Tuesday</option>
                      <option>Wednesday</option>
                      <option>Thursday</option>
                      <option>Friday</option>
                      <option>Saturday</option>
                      <option>Sunday</option>
                    </select>
                  </div>
                  <div class="form-group" style="max-width:160px;">
                    <label>Start</label>
                    <div style="display:flex; gap:6px;">
                      <input type="number" id="startHour" class="form-input" min="1" max="12" placeholder="2" style="width:48px;">
                      <input type="number" id="startMin" class="form-input" min="0" max="59" placeholder="00" style="width:56px;">
                      <select id="startAmpm" class="form-input" style="width:72px;">
                        <option>AM</option><option>PM</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group" style="max-width:160px;">
                    <label>End</label>
                    <div style="display:flex; gap:6px;">
                      <input type="number" id="endHour" class="form-input" min="1" max="12" placeholder="3" style="width:48px;">
                      <input type="number" id="endMin" class="form-input" min="0" max="59" placeholder="00" style="width:56px;">
                      <select id="endAmpm" class="form-input" style="width:72px;">
                        <option>AM</option><option>PM</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:10px;">
                <button class="cancel-btn" id="cancelCreateSection">Cancel</button>
                <button id="saveSectionBtn" class="save-question-btn">Add Section</button>
              </div>
            </div>
          </div>
        </div>

        <div id="sectionListWrap" style="width:100%; max-width:920px;">
          <h3 style="color:#501121; margin-bottom:8px;">Sections</h3>
          <!-- Scrollable box that contains the grid of section cards -->
          <div class="sections-box">
            <div id="sectionContainer" class="section-container"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Student Modal -->
<div class="account-modal" id="accountModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Create Student Account</h2>
      <span class="close" id="closeAccountModal">&times;</span>
    </div>

    <div class="section-info" style="margin-bottom:16px;">
      <i class="fas fa-users-class"></i> Section: <strong id="modalSectionName">Loading...</strong>
    </div>

    <form id="studentModalForm">
      <div class="form-row">
        <div class="form-group">
          <label>Contact Number</label>
          <input type="tel" id="modalContactNumber" class="form-input" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Address</label>
          <input type="text" id="modalAddress" class="form-input" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="modalUsername" class="form-input" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="modalEmail" class="form-input" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Last Name</label>
          <input type="text" id="modalLastname" class="form-input" required>
        </div>
        <div class="form-group">
          <label>First Name</label>
          <input type="text" id="modalFirstname" class="form-input" required>
        </div>
        <div class="form-group">
          <label>Middle Initial</label>
          <input type="text" id="modalMiddleInitial" class="form-input" maxlength="2" placeholder="A." />
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="modalPassword" class="form-input" required>
        </div>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:12px;">
        <button type="button" class="cancel-btn" id="cancelModalBtn">Cancel</button>
        <button type="submit" class="save-question-btn">Save Student</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast -->
<div id="successToast" style="display:none; position:fixed; right:20px; bottom:20px; background:#4cc9f0; color:#fff; padding:12px 18px; border-radius:10px; z-index:5000;">
  Student saved.
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

<!-- SheetJS for client-side Excel parsing -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
// --- Integrated logic from user, preserving UI ---
const firebaseConfig = {
  apiKey: "AIzaSyBkmM4hueT7PlnvV8FeRdp8g4rk0qQQrn4",
  authDomain: "midnightmathscape.firebaseapp.com",
  databaseURL: "https://midnightmathscape-e8e70-default-rtdb.firebaseio.com/",
  projectId: "midnightmathscape",
  storageBucket: "midnightmathscape.appspot.com",
  messagingSenderId: "1038485290511",
  appId: "1:1038485290511:web:c8aa78fbcd5266b706ed7a",
};
firebase.initializeApp(firebaseConfig);
const rtdb = firebase.database();

const totalSectionsEl = document.getElementById('totalSections');
const sectionContainer = document.getElementById('sectionContainer');
const saveSectionBtn = document.getElementById('saveSectionBtn');

const accountModal = document.getElementById('accountModal');
const closeAccountModal = document.getElementById('closeAccountModal');
const cancelModalBtn = document.getElementById('cancelModalBtn');
const studentModalForm = document.getElementById('studentModalForm');
const modalSectionNameEl = document.getElementById('modalSectionName');

let activeSectionId = null;
let activeSectionName = '';
let editingSectionId = null; // null = creating new, otherwise editing existing

// Collapsible / create modal controls
const toggleCreateSection = document.getElementById('toggleCreateSection');
const toggleIcon = document.getElementById('toggleIcon');
const createSectionModal = document.getElementById('createSectionModal');
const closeCreateSection = document.getElementById('closeCreateSection');
const cancelCreateSection = document.getElementById('cancelCreateSection');
const createSectionModalTitle = document.getElementById('createSectionModalTitle');

toggleCreateSection.addEventListener('click', () => {
  openCreateSectionModal(null, null);
});
closeCreateSection.addEventListener('click', () => {
  createSectionModal.style.display = 'none';
  toggleIcon.innerHTML = '&#x25BC;';
});
cancelCreateSection.addEventListener('click', () => {
  createSectionModal.style.display = 'none';
  toggleIcon.innerHTML = '&#x25BC;';
});
window.addEventListener('click', ev => {
  if (ev.target === createSectionModal) {
    createSectionModal.style.display = 'none';
    toggleIcon.innerHTML = '&#x25BC;';
  }
});

// Open create/edit modal. If id is provided then populate fields for edit.
function openCreateSectionModal(id=null, data=null){
  editingSectionId = id;
  toggleIcon.innerHTML = (id ? '&#x25B2;' : '&#x25B2;');
  createSectionModal.style.display = 'flex';

  if(id && data){
    createSectionModalTitle.textContent = 'Edit Section';
    saveSectionBtn.textContent = 'Save Changes';
    // populate fields from data (supports single schedule or map)
    document.getElementById('newSectionName').value = data.name || '';
    document.getElementById('newSectionCode').value = data.code || '';
    document.getElementById('newGradeLevel').value = data.gradeLevel || '';

    // pick first schedule found
    let sch = null;
    if(data.schedule){
      if(Array.isArray(data.schedule)) sch = data.schedule[0];
      else if(data.schedule.day) sch = data.schedule;
      else {
        const vals = Object.values(data.schedule);
        sch = vals.length ? vals[0] : null;
      }
    }
    if(sch){
      document.getElementById('scheduleDay').value = sch.day || 'Monday';
      document.getElementById('startHour').value = sch.start?.hour || '';
      document.getElementById('startMin').value = sch.start?.minute || '';
      document.getElementById('startAmpm').value = sch.start?.ampm || 'AM';
      document.getElementById('endHour').value = sch.end?.hour || '';
      document.getElementById('endMin').value = sch.end?.minute || '';
      document.getElementById('endAmpm').value = sch.end?.ampm || 'PM';
    } else {
      // clear schedule inputs
      document.getElementById('scheduleDay').value = 'Monday';
      document.getElementById('startHour').value = '';
      document.getElementById('startMin').value = '';
      document.getElementById('startAmpm').value = 'AM';
      document.getElementById('endHour').value = '';
      document.getElementById('endMin').value = '';
      document.getElementById('endAmpm').value = 'PM';
    }
  } else {
    // creating new
    createSectionModalTitle.textContent = 'Add Section';
    saveSectionBtn.textContent = 'Add Section';
    document.getElementById('newSectionName').value = '';
    document.getElementById('newSectionCode').value = '';
    document.getElementById('newGradeLevel').value = '';
    document.getElementById('scheduleDay').value = 'Monday';
    document.getElementById('startHour').value = '';
    document.getElementById('startMin').value = '';
    document.getElementById('startAmpm').value = 'AM';
    document.getElementById('endHour').value = '';
    document.getElementById('endMin').value = '';
    document.getElementById('endAmpm').value = 'PM';
  }
}

// Save Section (create or update)
saveSectionBtn.addEventListener('click', async () => {
  const name = document.getElementById('newSectionName').value.trim();
  const code = (document.getElementById('newSectionCode').value || '').trim();
  const grade = parseInt(document.getElementById('newGradeLevel').value) || null;
  const day = document.getElementById('scheduleDay').value;
  const startHour = document.getElementById('startHour').value.trim();
  const startMin = document.getElementById('startMin').value.trim();
  const startAmpm = document.getElementById('startAmpm').value;
  const endHour = document.getElementById('endHour').value.trim();
  const endMin = document.getElementById('endMin').value.trim();
  const endAmpm = document.getElementById('endAmpm').value;

  if(!name){ alert('Enter section name'); return; }

  const schedule = {
    day,
    start: { hour: startHour || '', minute: startMin || '', ampm: startAmpm },
    end: { hour: endHour || '', minute: endMin || '', ampm: endAmpm }
  };

  const payload = {
    name,
    code: code || null,
    gradeLevel: grade,
    schedule,
    updatedAt: Date.now()
  };

  if(editingSectionId){
    // update existing
    await rtdb.ref(`SectionList/${editingSectionId}`).update(payload);
  } else {
    // create new
    payload.createdAt = Date.now();
    const newRef = rtdb.ref('SectionList').push();
    await newRef.set(payload);
  }

  // clear form
  document.getElementById('newSectionName').value = '';
  document.getElementById('newSectionCode').value = '';
  document.getElementById('newGradeLevel').value = '';
  document.getElementById('startHour').value = '';
  document.getElementById('startMin').value = '';
  document.getElementById('endHour').value = '';
  document.getElementById('endMin').value = '';

  // hide modal and reset edit mode
  createSectionModal.style.display = 'none';
  toggleIcon.innerHTML = '&#x25BC;';
  editingSectionId = null;
});

/* Real-time Section Listener */
rtdb.ref('SectionList').on('value', snap => {
  sectionContainer.innerHTML = '';
  if(!snap.exists()){ totalSectionsEl.textContent='0'; return; }
  const data = snap.val();
  const entries = Object.entries(data);
  totalSectionsEl.textContent = entries.length;

  // helpers
  function pad(n){ n = n == null ? '' : String(n); if(n==='') return '00'; return n.length===1? '0'+n : n; }
  function formatTimeObj(t){
    if(!t) return '';
    const h = t.hour || '';
    const m = (t.minute==null || t.minute==='') ? '00' : pad(t.minute);
    const am = t.ampm || '';
    if(!h) return '';
    return `${h}:${m} ${am}`.trim();
  }
  function formatRange(s){
    if(!s) return '';
    const start = formatTimeObj(s.start);
    const end = formatTimeObj(s.end);
    return start && end ? `${start} - ${end}` : (start || end || '');
  }

  entries.forEach(([id, sec]) => {
    const card = document.createElement('div');
    card.className='section-card';

    // build schedule HTML (handles single schedule, array or object map)
    let scheduleHTML = '';
    if(sec.schedule){
      if(Array.isArray(sec.schedule)){
        sec.schedule.forEach(sch => {
          scheduleHTML += `<div class="schedule-row"><div>${sch.day||''}</div><div>${formatRange(sch)}</div></div>`;
        });
      } else if(sec.schedule.day){
        scheduleHTML = `<div class="schedule-row"><div>${sec.schedule.day||''}</div><div>${formatRange(sec.schedule)}</div></div>`;
      } else {
        // object with multiple keys
        Object.values(sec.schedule).forEach(sch => {
          scheduleHTML += `<div class="schedule-row"><div>${sch?.day||''}</div><div>${formatRange(sch)}</div></div>`;
        });
      }
    } else {
      scheduleHTML = `<div style="color:#777; padding:8px 0;">No schedule</div>`;
    }

    card.innerHTML = `
      <div class="card-top">
        <div class="card-top-left">
          <div class="title-row">
            <h3 class="section-title">${sec.name || ''}</h3>
            <div class="section-code">${sec.code || ''}</div>
          </div>
        </div>
        <div class="card-actions">
          <div class="grade-level">Grade ${sec.gradeLevel ?? '-'}</div>
          <div>
            <button class="icon-btn edit-btn" data-id="${id}" title="Edit"><i class="fas fa-edit"></i></button>
            <button class="delete-btn" data-id="${id}" title="Delete"><i class="fas fa-trash"></i></button>
          </div>
        </div>
      </div>

      <div class="section-code-divider"></div>

      <div class="schedule-list">
        ${scheduleHTML}
      </div>

      <div class="section-code-divider" style="margin-top:8px;"></div>

      <div class="card-footer">
        <div class="left">
          <div class="student-count">Loading...</div>
        </div>
        <div class="right">
          <button class="add-btn" data-id="${id}">Add Student</button>
          <a href="studentList.html" class="see-students" data-id="${id}">See Students <i class="fas fa-chevron-right"></i></a>
        </div>
      </div>
    `;

    sectionContainer.appendChild(card);

    // events
    const addBtn = card.querySelector('.add-btn');
    if(addBtn) addBtn.addEventListener('click', ()=>openAccountModalForSection(id, sec.name));

    const delBtn = card.querySelector('.delete-btn');
    if(delBtn) delBtn.addEventListener('click', async ()=>{
      if(!confirm('Delete this section?')) return;
      await rtdb.ref(`SectionList/${id}`).remove();
    });

    // edit: open same modal and prefill
    const editBtn = card.querySelector('.edit-btn');
    if(editBtn) editBtn.addEventListener('click', ()=> {
      openCreateSectionModal(id, sec);
    });

    updateStudentCount(id, card);
  });
});

/* Update Student Count */
async function updateStudentCount(sectionId, cardEl){
  // Count students from SectionList/{sectionId}/students which is the authoritative list
  try{
    const snap = await rtdb.ref(`SectionList/${sectionId}/students`).once('value');
    const count = snap.exists() ? Object.keys(snap.val()).length : 0;
    const sc = cardEl.querySelector('.student-count');
    if(sc) sc.textContent = `${count} ${count === 1 ? 'Student' : 'Students'}`;
  }catch(err){
    console.error('updateStudentCount error', err);
    const sc = cardEl.querySelector('.student-count');
    if(sc) sc.textContent = `0 Students`;
  }
}

/* Account Modal */
function openAccountModalForSection(id, name){
  activeSectionId = id;
  activeSectionName = name;
  modalSectionNameEl.textContent = name;
  studentModalForm.reset();
  accountModal.style.display='flex';
}
closeAccountModal.addEventListener('click', ()=>accountModal.style.display='none');
cancelModalBtn.addEventListener('click', ()=>accountModal.style.display='none');
window.addEventListener('click', ev=>{ if(ev.target===accountModal) accountModal.style.display='none'; });

/* Generate 4-digit unique ID */
async function generateUniqueId(){
  let id, exists=true;
  while(exists){
    id=Math.floor(1000+Math.random()*9000).toString();
    const snap=await rtdb.ref(`StudentAccount/${id}`).once('value');
    exists=snap.exists();
  }
  return id;
}

/* Submit Student Form with duplication protection */
let savingStudent = false;
studentModalForm.addEventListener('submit', async e=>{
  e.preventDefault();
  if(!activeSectionId) return alert('No section selected');

  if(savingStudent) return; // already in progress
  savingStudent = true;
  const submitBtn = studentModalForm.querySelector('button[type="submit"]');
  if(submitBtn) submitBtn.disabled = true;

  try{
    const firstname=document.getElementById('modalFirstname').value.trim();
    const lastname=document.getElementById('modalLastname').value.trim();
    const pass=document.getElementById('modalPassword').value;
    const contactNumber=document.getElementById('modalContactNumber').value.trim();
    const address=document.getElementById('modalAddress').value.trim();
    const username=document.getElementById('modalUsername').value.trim();
    const email=document.getElementById('modalEmail').value.trim();

    if(!firstname||!lastname||!pass||!username||!email) {
      alert('Fill required fields');
      return;
    }

    const lowerEmail = email.toLowerCase();
    const lowerUsername = username.toLowerCase();

    // Check for existing email in Cridentials (avoid duplicates)
    try{
      const emailSnap = await rtdb.ref('Cridentials').orderByChild('email').equalTo(lowerEmail).once('value');
      if(emailSnap.exists()){
        const foundIds = Object.keys(emailSnap.val() || {});
        alert('A student with this email already exists. ID: ' + (foundIds[0] || 'unknown'));
        return;
      }
    }catch(err){
      console.warn('Email uniqueness check failed', err);
      // proceed — client-side check failed (server-side enforcement recommended)
    }

    // Check for existing username in Cridentials
    try{
      const userSnap = await rtdb.ref('Cridentials').orderByChild('username').equalTo(lowerUsername).once('value');
      if(userSnap.exists()){
        const foundIds = Object.keys(userSnap.val() || {});
        alert('Username already taken. ID: ' + (foundIds[0] || 'unknown'));
        return;
      }
    }catch(err){
      console.warn('Username uniqueness check failed', err);
    }

    // Passed duplication checks — create new student id and write atomically
    const newId = await generateUniqueId();
    const middleInitialVal = (document.getElementById('modalMiddleInitial').value||'').trim();

    // Use multi-path update to reduce inconsistent state window
    const updates = {};
    updates[`StudentAccount/${newId}`] = { firstname: firstname, lastname: lastname, pass };
    updates[`Cridentials/${newId}`] = { firstname: firstname, lastname: lastname, middleInitial: middleInitialVal, contactNumber, address, username, email: lowerEmail, sectionId: activeSectionId, createdAt: Date.now(), status: 'active' };
    updates[`SectionList/${activeSectionId}/students/${newId}`] = true;

    await rtdb.ref().update(updates);

    document.getElementById('successToast').style.display='block';
    setTimeout(()=>document.getElementById('successToast').style.display='none',2500);

    accountModal.style.display='none';

  }catch(err){
    console.error('Save student error', err);
    alert('Failed to save student: ' + (err.message || err));
  } finally {
    savingStudent = false;
    if(submitBtn) submitBtn.disabled = false;
  }
});

/* ------------------ Batch upload (Excel -> students) ------------------ */
const batchFileInput = document.getElementById('batchFileInput');
const batchChooseBtn = document.getElementById('batchChooseBtn');
const batchUploadBtn = document.getElementById('batchUploadBtn');
const batchSectionSelect = document.getElementById('batchSectionSelect');
const batchStatus = document.getElementById('batchStatus');

batchChooseBtn.addEventListener('click', () => batchFileInput.click());

batchFileInput.addEventListener('change', () => {
  const f = batchFileInput.files[0];
  batchStatus.textContent = f ? `Selected: ${f.name}` : 'No file selected';
});

// populate sections dropdown once (and refresh on changes)
function populateBatchSectionSelect(data){
  // data = object map from SectionList
  batchSectionSelect.innerHTML = '<option value="">Select section...</option>';
  if(!data) return;
  Object.entries(data).forEach(([id, sec])=>{
    const opt = document.createElement('option');
    opt.value = id;
    opt.textContent = `${sec.name || 'Unnamed'} ${sec.code ? '• '+sec.code : ''}`;
    batchSectionSelect.appendChild(opt);
  });
}

// initial load and live updates
rtdb.ref('SectionList').on('value', snap => {
  const v = snap.exists() ? snap.val() : null;
  populateBatchSectionSelect(v);
});

// parse Excel (or CSV) and upload rows to Firebase under selected section
batchUploadBtn.addEventListener('click', async () => {
  const file = batchFileInput.files[0];
  const sectionId = batchSectionSelect.value;
  if(!file) return alert('Choose an Excel/CSV file first.');
  if(!sectionId) return alert('Select a section to assign students to.');

  batchStatus.textContent = 'Parsing file...';

  const reader = new FileReader();
  reader.onload = async (evt) => {
    try{
      const data = evt.target.result;
      let workbook;
      if(file.name.endsWith('.csv')){
        // CSV: read as text and convert
        const text = typeof data === 'string' ? data : new TextDecoder().decode(data);
        const ws = XLSX.utils.sheet_new();
        const parsed = XLSX.utils.sheet_to_json(XLSX.read(text, {type:'string'}).Sheets.Sheet1, {header:1});
        workbook = XLSX.read(text, {type:'string'});
      } else {
        workbook = XLSX.read(data, {type: 'binary'});
      }

      const firstSheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheetName];
      const rows = XLSX.utils.sheet_to_json(worksheet, {defval: ''});
      if(!rows || rows.length === 0) { batchStatus.textContent = 'No rows found.'; return; }

  // Expected column names (case-insensitive): firstName, lastName, pass, contactNumber, address, username, email, middleInitial
      batchStatus.textContent = `Found ${rows.length} rows — uploading...`;
      let success = 0, skipped = 0, failed = 0;

      for(let i=0;i<rows.length;i++){
        const r = rows[i];
        // normalize keys
        const norm = {};
        Object.keys(r).forEach(k => { if(k) norm[k.trim().toLowerCase()] = r[k]; });

        const firstname = (norm.firstname || norm.first_name || norm['first name'] || '').toString().trim();
        const lastname = (norm.lastname || norm.last_name || norm['last name'] || '').toString().trim();
        const pass = (norm.pass || norm.password || norm.pwd || '').toString();
  // studentNumber intentionally ignored (we use StudentAccount key as canonical id)
  const studentNumber = '';
        const contactNumber = (norm.contactnumber || norm['contact number'] || norm.contact || '').toString();
        const address = (norm.address || '').toString();
        const username = (norm.username || '').toString().trim();
        const email = (norm.email || '').toString().trim();
        const middleInitialVal = (norm.middleinitial || norm['middle initial'] || '').toString().trim();

        // basic validation: need firstname, lastname, pass and username & email (at least username/email)
        if(!firstname || !lastname || !pass){
          skipped++;
          continue;
        }

        try{
          const newId = await generateUniqueId();
          // StudentAccount: only minimal canonical fields
          await rtdb.ref(`StudentAccount/${newId}`).set({ firstname: firstname, lastname: lastname, pass });
          // Cridentials: keep auxiliary fields and section membership
          await rtdb.ref(`Cridentials/${newId}`).set({ firstname: firstname, lastname: lastname, middleInitial: middleInitialVal, contactNumber, address, username, email, sectionId, createdAt: Date.now(), status: 'active' });
          await rtdb.ref(`SectionList/${sectionId}/students/${newId}`).set(true);
          success++;
          batchStatus.textContent = `Uploading... ${i+1}/${rows.length} (success ${success})`;
        }catch(err){
          console.error('row upload error', err);
          failed++;
        }
      }

      batchStatus.textContent = `Done. Success: ${success}, Skipped: ${skipped}, Failed: ${failed}`;
      // clear file input so user can choose again
      batchFileInput.value = '';
    }catch(err){
      console.error(err);
      batchStatus.textContent = 'Error parsing or uploading file. See console.';
    }
  };

  // read as binary string for xlsx
  if(file.name.endsWith('.csv')){
    reader.readAsText(file);
  } else {
    reader.readAsBinaryString(file);
  }
});
/* ------------------ end batch upload ------------------ */

/* toggle import controls (keeps existing batch upload handlers intact) */
(function(){
  const toggleBtn = document.getElementById('toggleImportBtn');
  const wrap = document.getElementById('batchControlsWrap');
  if(!toggleBtn || !wrap) return;
  toggleBtn.addEventListener('click', () => {
    const isOpen = wrap.style.display !== 'none' && wrap.style.display !== '';
    wrap.style.display = isOpen ? 'none' : 'flex';
    toggleBtn.setAttribute('aria-expanded', !isOpen);
    const chev = toggleBtn.querySelector('.chev');
    if(chev) chev.textContent = isOpen ? '▾' : '▴';
  });
})();

/* Download Excel template (placed beside Import via Excel) */
(function(){
  const btn = document.getElementById('downloadTemplateBtn');
  if(!btn) return;
  btn.addEventListener('click', () => {
    // header + two sample rows
    const ws_data = [
      ["firstname","lastname","pass","contactNumber","address","username","email","middleInitial","sectionId"],
      ["Juan","Dela Cruz","secret123","09171234567","123 Main St","juan.dc","juan@example.com","A",""],
      ["Maria","Santos","password!","09179876543","45 Side St","maria.s","maria@example.com","B",""]
    ];
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Students");
    XLSX.writeFile(wb, "students-template.xlsx");
  });
})();



</script>
<!-- Choose Existing Student Modal -->
<div id="chooseStudentModal" class="account-modal" style="display:none; align-items:center;">
  <div class="modal-content" style="max-width:800px; width:95%;">
    <div class="modal-header" style="margin-bottom:6px; align-items:center;">
      <h3 style="margin:0">Choose existing student to transfer</h3>
      <span id="closeChooseStudentModal" class="close" style="cursor:pointer">&times;</span>
    </div>
    <div style="margin-top:12px;">
      <input id="chooseStudentSearch" placeholder="Search by name, ID, username, or email..." style="width:100%; padding:8px; box-sizing:border-box;" />
    </div>
    <div style="margin-top:12px; max-height:300px; overflow:auto; border:1px solid #eee;">
      <table style="width:100%; border-collapse:collapse;">
        <thead style="position:sticky; top:0; background:#fafafa;">
          <tr>
            <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Select</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Student</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Current Section</th>
          </tr>
        </thead>
        <tbody id="chooseStudentTbody"></tbody>
      </table>
    </div>

    <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
      <label style="white-space:nowrap;">Transfer to:</label>
      <select id="chooseTargetSection" style="flex:1; padding:8px;"></select>
    </div>

    <div style="margin-top:16px; display:flex; justify-content:flex-end; gap:8px;">
      <button id="cancelChooseBtn" type="button" class="cancel-btn">Cancel</button>
      <button id="okChooseBtn" type="button" class="save-question-btn">OK</button>
    </div>
  </div>
</div>

<style>
  /* highlight selected table row */
  #chooseStudentTbody tr.selected { background:#e6f7ff; }
  #chooseStudentTbody tr { cursor:pointer; }
</style>

<script>
  // Choose-existing-student modal + transfer logic
  (function(){
    const rtdbRef = firebase && firebase.database ? firebase.database() : null;
    if(!rtdbRef) return;

    // create Choose Existing button next to cancel button in student modal
    document.addEventListener('DOMContentLoaded', ()=>{
      const cancelBtn = document.getElementById('cancelModalBtn');
      if(cancelBtn && !document.getElementById('chooseExistingBtn')){
        const chooseBtn = document.createElement('button');
        chooseBtn.id = 'chooseExistingBtn';
        chooseBtn.type = 'button';
        chooseBtn.className = cancelBtn.className || 'btn-secondary';
        chooseBtn.textContent = 'Choose existing students';
        chooseBtn.style.marginLeft = '8px';
        chooseBtn.addEventListener('click', openChooseStudentModal);
        cancelBtn.parentNode.insertBefore(chooseBtn, cancelBtn.nextSibling);
      }
    });

    // open modal and load students + sections
    async function openChooseStudentModal(){
      const modal = document.getElementById('chooseStudentModal');
      const tbody = document.getElementById('chooseStudentTbody');
      const search = document.getElementById('chooseStudentSearch');
      const sectionSelect = document.getElementById('chooseTargetSection');
  tbody.innerHTML = '<tr><td colspan="3" style="padding:12px">Loading...</td></tr>';
      sectionSelect.innerHTML = '<option>Loading...</option>';
      modal.style.display = 'flex';

      // load sections
      const sectionsSnap = await rtdbRef.ref('SectionList').once('value');
      const sections = sectionsSnap.val() || {};
      const sectionMap = {};
      sectionSelect.innerHTML = '';
      Object.keys(sections).forEach(sid => {
        const s = sections[sid];
        const opt = document.createElement('option');
        opt.value = sid;
        opt.textContent = s.name || s.sectionName || sid;
        sectionSelect.appendChild(opt);
        sectionMap[sid] = opt.textContent;
      });

      // load students: merge StudentAccount and Cridentials so we can render names and other data
      const credsSnap = await rtdbRef.ref('Cridentials').once('value');
      const acctSnap = await rtdbRef.ref('StudentAccount').once('value');
      const creds = credsSnap.val() || {};
      const accts = acctSnap.val() || {};

      // build merged map where each key is the studentId (account id like '0404')
      // include ids present in either Cridentials or StudentAccount (union)
      // Prefer Cridentials for auxiliary fields (address, contactNumber, email, middleInitial, sectionId)
      const students = {};
      const allIds = new Set([...(Object.keys(creds)||[]), ...(Object.keys(accts)||[])]);
      allIds.forEach(id => {
        const c = creds[id] || {};
        const a = accts[id] || {};
        // merged: keep minimal canonical from StudentAccount (firstname, lastname, pass) but prefer Cridentials for others
        const merged = Object.assign({}, a);
        // if Cridentials has firstname/lastname prefer that (they may be lowercase)
        merged.firstname = (c.firstname || c.firstName || a.firstname || a.firstName || '');
        merged.lastname = (c.lastname || c.lastName || a.lastname || a.lastName || '');
        merged.middleInitial = c.middleInitial || c.middleinitial || a.middleInitial || '';
        merged.contactNumber = c.contactNumber || c.contactnumber || a.contactNumber || '';
        merged.address = c.address || a.address || '';
        merged.username = c.username || a.username || '';
        merged.email = c.email || a.email || '';
        merged.sectionId = c.sectionId || a.sectionId || '';
        merged.pass = a.pass || c.pass || '';
        merged.studentId = id;
        students[id] = merged;
      });

      renderStudentRows(students, sectionMap);

  // search handler (matches id, name, username, email)
      search.oninput = () => {
        const q = search.value.trim().toLowerCase();
        const filtered = Object.keys(students).filter(id => {
          const s = students[id] || {};
          const name = ((s.firstName||s.firstname||'') + ' ' + (s.lastName||s.lastname||'')).toLowerCase();
    const num = '';
          const sid = String(id).toLowerCase();
          return sid.includes(q) || name.includes(q) || num.includes(q) || (s.username||'').toLowerCase().includes(q) || (s.email||'').toLowerCase().includes(q);
        }).reduce((acc,id)=>{ acc[id]=students[id]; return acc; }, {});
        renderStudentRows(filtered, sectionMap);
      };
    }

    function renderStudentRows(studentsObj, sectionMap){
      const tbody = document.getElementById('chooseStudentTbody');
      tbody.innerHTML = '';
      if(!studentsObj || Object.keys(studentsObj).length === 0){
        tbody.innerHTML = '<tr><td colspan="3" style="padding:12px">No students found.</td></tr>';
        return;
      }
      Object.keys(studentsObj).forEach(id => {
        const s = studentsObj[id] || {};
        const tr = document.createElement('tr');
        tr.dataset.studentId = id;
        const name = (s.firstName || s.firstname || '') + (s.lastName || s.lastname ? (' ' + (s.lastName || s.lastname)) : '');
        tr.innerHTML = `
          <td style="padding:8px; border-bottom:1px solid #eee;"><input type="radio" name="chooseStudentRadio" value="${id}"></td>
          <td style="padding:8px; border-bottom:1px solid #eee;"><strong>${name || (s.username||s.email||'Unnamed')}</strong><div style="font-size:0.85rem;color:#666">ID: ${id}</div></td>
          <td style="padding:8px; border-bottom:1px solid #eee;">${sectionMap[(s.sectionId||'')]|| (s.sectionId||'')}</td>
        `;
        tr.addEventListener('click', (e)=>{
          // toggle radio and highlight
          const radio = tr.querySelector('input[type=radio]');
          if(radio) radio.checked = true;
          // remove selected from others
          Array.from(tbody.querySelectorAll('tr')).forEach(r=>r.classList.remove('selected'));
          tr.classList.add('selected');
        });
        tbody.appendChild(tr);
      });
    }

    // close handlers
    document.addEventListener('click', (e)=>{
      if(e.target && e.target.id === 'closeChooseStudentModal') closeChooseStudentModal();
      if(e.target && e.target.id === 'cancelChooseBtn') closeChooseStudentModal();
    });

    function closeChooseStudentModal(){
      const modal = document.getElementById('chooseStudentModal');
      if(modal) modal.style.display = 'none';
    }

    // OK -> transfer
    document.addEventListener('click', async (e)=>{
      if(e.target && e.target.id === 'okChooseBtn'){
        const tbody = document.getElementById('chooseStudentTbody');
        const checked = tbody.querySelector('input[type=radio]:checked');
        if(!checked){ alert('Please select a student to transfer.'); return; }
        const studentId = checked.value;
        const targetSection = document.getElementById('chooseTargetSection').value;
        if(!targetSection){ alert('Please choose a target section.'); return; }
        try{
          // read current StudentAccount to find old section
          const cSnap = await rtdbRef.ref('StudentAccount/' + studentId).once('value');
          const c = cSnap.val() || {};
          let oldSection = c.sectionId || null;

          // If StudentAccount doesn't have sectionId, prefer Cridentials' sectionId
          if(!oldSection){
            const credSnap = await rtdbRef.ref('Cridentials/' + studentId).once('value');
            const cred = credSnap.val() || {};
            if(cred.sectionId) oldSection = cred.sectionId;
          }

          // Fallback: if StudentAccount doesn't have sectionId (legacy/missing), search SectionList for membership
          if(!oldSection){
            const sectionsSnap = await rtdbRef.ref('SectionList').once('value');
            const sections = sectionsSnap.val() || {};
            for(const sid of Object.keys(sections)){
              const sec = sections[sid];
              if(sec && sec.students && sec.students[studentId]){ oldSection = sid; break; }
            }
          }

          // if already in that section: ask for confirmation and allow proceeding
          if(oldSection === targetSection){
            const confirmed = confirm('Are you sure do you want to transfer this student to other section?');
            if(!confirmed){ return; }
          }

          // perform updates: update Cridentials.sectionId (auxiliary store), remove from old section (only if different and known), add to new section
          const updates = {};
          updates['Cridentials/' + studentId + '/sectionId'] = targetSection;
          // also keep StudentAccount minimal (no sectionId) — do not write sectionId into StudentAccount
          if(oldSection && oldSection !== targetSection) updates['SectionList/' + oldSection + '/students/' + studentId] = null;
          updates['SectionList/' + targetSection + '/students/' + studentId] = true;

          await rtdbRef.ref().update(updates);

          // show success (reuse successToast if exists)
          const toast = document.getElementById('successToast');
          if(toast){ toast.style.display = 'block'; setTimeout(()=>{ toast.style.display='none'; }, 2000); }
          closeChooseStudentModal();
        }catch(err){
          console.error('Transfer error', err);
          alert('Failed to transfer student: ' + (err.message || err));
        }
      }
    });
  })();
</script>

</body>
</html>
