<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Account & Section Setup</title>

<link rel="stylesheet" href="dashboard.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
/* --- Updated styles: improved card layout + modal --- */
#accsetup { color: white; font-weight: 600; }

.section-container {
  display: grid;
  grid-template-columns: repeat(2, minmax(280px, 1fr));
  gap: 18px;
  padding: 10px;
  max-height: 72vh;
  overflow-y: auto;
  box-sizing: border-box;
}

/* Make first card (create) span both columns if present */
.section-container > .card:first-child {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: transparent;
  box-shadow: none;
}

/* Card: use flexible layout and allow contents to wrap/shrink */
.section-card {
  background: #fff;
  border-radius: 12px;
  padding: 14px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.05);
  transition: transform .12s ease, box-shadow .12s ease;
  box-sizing: border-box;
  min-height: 120px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  overflow: hidden;
}
.section-card:hover { transform: translateY(-3px); box-shadow: 0 10px 24px rgba(0,0,0,0.08); }

/* Card top / title alignment fixes */
.card-top {
  display: flex;
  justify-content: space-between;
  gap: 12px;
  align-items: flex-start; /* keep actions top-aligned */
}
.card-top-left {
  flex: 1 1 auto; /* allow title area to grow/shrink */
  min-width: 0;   /* allow flexible children to wrap correctly */
  display: block; /* keep block for stacking if needed */
}

/* New inline title row so code sits to the right of title */
.title-row {
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Make title single-line with ellipsis so it won't push the code down */
.section-title {
  font-size: 1.25rem;
  color: #7e142a;
  margin: 0;
  font-weight: 800;
  line-height: 1.05;
  white-space: nowrap;            /* prevent wrapping */
  overflow: hidden;               /* clip overflow */
  text-overflow: ellipsis;        /* show ellipsis */
  min-width: 0;                   /* allow truncation inside flex */
}

/* Keep code small and on the same row */
.section-code {
  color: #7a7a7a;
  font-size: 0.82rem;
  margin-top: 0;                  /* remove top gap so it stays on same line */
  display: inline-block;
  white-space: nowrap;
  flex: 0 0 auto;
  text-transform: uppercase;
  letter-spacing: 0.6px;
}

/* Actions column stays compact */
.card-actions {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 6px;
  min-width: 92px;
  flex: 0 0 auto;
}

/* Icon buttons unchanged but ensure they don't force layout */
.icon-btn, .delete-btn {
  background: transparent;
  border: 0;
  padding: 6px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1rem;
  color: #7e142a;
}
.delete-btn { color: #d64f4f; }
.icon-btn:hover, .delete-btn:hover { background: rgba(126,20,42,0.06); }

/* Divider and schedule: aligned, schedule time can wrap */
.section-code-divider { height: 1px; background: #f3eaea; margin: 10px 0; border-radius: 2px; }
.schedule-list { padding: 4px 0 6px 0; font-size: 0.95rem; color: #333; }
.schedule-row { display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px dashed #f6f2f2; gap: 12px; }
.schedule-row:last-child { border-bottom:0; }

/* Day column fixed-ish, time column flexible and wraps */
.schedule-day { color:#666; flex: 0 0 110px; font-weight:600; font-size:0.92rem; white-space:normal; }
.schedule-time { color:#222; font-weight:600; text-align:right; flex: 1 1 auto; white-space:normal; word-break:break-word; }

/* Footer */
.card-footer { display:flex; justify-content:space-between; align-items:center; margin-top:8px; gap:10px; }
.student-count { background:#f6f6f7; color:#333; padding:6px 10px; border-radius:14px; font-weight:700; font-size:0.92rem; }

/* Buttons */
.add-btn { background:#7e142a; color:#fff; border:0; padding:8px 10px; border-radius:8px; cursor:pointer; font-size:0.92rem; }
.add-btn:hover { background:#5a0d1a; }
.see-students { color:#7e142a; text-decoration:none; font-weight:700; font-size:0.92rem; margin-left:8px; }

/* Modal */
.account-modal { display:none; position:fixed; z-index:4000; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.45); align-items:center; justify-content:center; padding:20px; }
.account-modal .modal-content { background:white; width:100%; max-width:900px; border-radius:12px; padding:25px; box-shadow:0 8px 20px rgba(0,0,0,0.15); max-height:90vh; overflow:auto; }
.account-modal .close { font-size:24px; cursor:pointer; color:#6c757d; }
.account-modal .close:hover { color:#a72344; }
.account-modal .modal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:18px; }
.account-modal h2 { margin:0; font-size:1.5em; color:#8A1532; }
.account-modal .form-row { display:flex; gap:15px; margin-bottom:15px; }
.account-modal .form-group { flex:1; }
.account-modal .form-group label { display:block; margin-bottom:5px; font-weight:500; }
.account-modal .form-input { width:100%; padding:8px 12px; border:1px solid #ddd; border-radius:4px; box-sizing:border-box; }
.account-modal .save-question-btn { background:#8A1532; color:#fff; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; margin-left:10px; }
.account-modal .save-question-btn:hover { background:#501121; }
.account-modal .cancel-btn { background:#ddd; color:#333; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; }
.account-modal .cancel-btn:hover { background:#bbb; }

@media (max-width:700px){
  .section-card{ max-width:100%; }
  .card-top{flex-direction:column;align-items:flex-start;}
  .card-actions{align-items:flex-start;}
  .account-modal .form-row{flex-direction:column;}
}

/* create a scrollable box that contains the section cards */
.sections-box{
  background: transparent;
  border-radius: 12px;
  padding: 12px;;
  max-height: 520px;         /* height of the scrollable box */
  overflow-y: auto;          /* enable vertical scroll for cards only */
  box-sizing: border-box;
}

/* adjust grid so it grows inside the box (no own scrolling) */
.section-container{
  display: grid;
  grid-template-columns: repeat(2, minmax(280px, 1fr));
  gap: 18px;
  padding: 8px 4px;          /* keep inner spacing small */
  max-height: none;          /* allow container to expand inside sections-box */
  overflow: visible;
  box-sizing: border-box;
}

/* optionally show a subtle inner scrollbar padding so content doesn't butt against edges */
.sections-box::-webkit-scrollbar { width: 10px; }
.sections-box::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.06); border-radius:6px; }

/* Responsive overrides (append) */
@media (max-width:1200px){
  .section-container {
    grid-template-columns: repeat(2, minmax(260px, 1fr));
    gap: 16px;
  }
  .sections-box { padding: 18px; max-height: calc(100vh - 140px); }
  .section-card { min-height: 160px; padding: 16px; }
  .section-title { font-size: 1.35rem; }
}

@media (max-width:900px){
  /* single column layout for tablets / small laptops */
  .section-container { grid-template-columns: 1fr; }
  .section-container > .card:first-child { grid-column: auto; }
  .sections-box { padding: 14px; max-height: calc(100vh - 120px); }

  /* keep top row compact: allow title to wrap but keep code close */
  .card-top { align-items: center; gap: 10px; }
  .card-top-left { min-width: 0; }
  .title-row { display: flex; flex-direction: column; gap: 6px; }
  .section-title {
    white-space: normal;           /* allow wrapping on small screens */
    overflow: visible;
    text-overflow: unset;
    font-size: 1.15rem;
  }
  .section-code {
    display: block;
    margin-top: 4px;
    font-size: 0.85rem;
  }

  /* move action icons into a single row */
  .card-actions { flex-direction: row; gap: 10px; align-items: center; }

  /* tighten schedule and footer */
  .schedule-row { padding: 6px 0; font-size: 0.94rem; }
  .schedule-day { flex: 0 0 92px; }
  .schedule-time { min-width: 110px; text-align:right; }

  .student-count { font-size: 0.9rem; padding: 6px 10px; }
  .add-btn { padding: 8px 12px; font-size: 0.95rem; }
}

@media (max-width:480px){
  /* phones: compact spacing and sizes */
  .sections-box { padding: 10px; max-height: calc(100vh - 100px); }
  .section-card { padding: 12px; min-height: 120px; }
  .section-title { font-size: 1.05rem; }
  .section-code { font-size: 0.78rem; }

  /* schedule compact */
  .schedule-day { flex: 0 0 72px; font-size: 0.85rem; }
  .schedule-time { min-width: 90px; font-size: 0.9rem; text-align:right; }

  /* make buttons slightly larger tap targets */
  .add-btn, .save-question-btn { padding: 9px 12px; font-size: 0.95rem; }
  .icon-btn, .delete-btn { padding: 8px; }
}

/* --- Existing styles continue --- */
</style>
</head>
<body>
<div class="container-wrap">
  <div class="-main">
    <div class="main-menu">
      <img src="images/profile logo.PNG" width="60" height="60">
      <p>Math teacher</p>
      <div class="main-section">
        <p>Main</p>
        <a href="studentList.html">Student List</a>
        <a href="studentProgress.html">Student Progress</a>
        <a href="evalControl.html">Evaluation & Control</a>
        <a href="accSecSetup.html">Account & Section Setup</a>
      </div>
    </div>
  </div>

  <div class="-side">
    <div class="top-bar">
  <div style="flex:1"></div>
  <div class="logout"><a href="#" id="logoutLink">Logout</a></div>
    </div>

    <div class="dash-window">
      <div class="header-title"><h1>Account & Section Setup</h1></div>
      <div class="data-container">
        <p>Total Sections: <span id="totalSections">0</span></p>

        <div class="section-container">
          <div class="card" style="width:100%; max-width:920px; margin-bottom:20px;">
              <h3 style="cursor:pointer;user-select:none;" id="toggleCreateSection">Create New Section <span id="toggleIcon" style="font-size:1.2em;">&#x25BC;</span></h3>
              <!-- Button opens modal; modal defined below -->
            </div>
          </div>
          <!-- Create Section Modal -->
          <div class="section-modal account-modal" id="createSectionModal" style="display:none;">
            <div class="modal-content" style="max-width:760px;">
              <div class="modal-header">
                <h2 id="createSectionModalTitle">Add Section</h2>
                <span class="close" id="closeCreateSection">&times;</span>
              </div>
              <div class="section-form">
                <div class="form-row">
                  <div class="form-group">
                    <label>Section Code</label>
                    <input type="text" id="newSectionCode" class="form-input" placeholder="e.g. KAM01901">
                  </div>
                  <div class="form-group">
                    <label>Grade Level</label>
                    <input type="number" id="newGradeLevel" class="form-input" min="1" max="12" placeholder="6">
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group" style="flex:2">
                    <label>Section Name</label>
                    <input type="text" id="newSectionName" class="form-input" placeholder="e.g. Kamagong">
                  </div>
                </div>
                <div style="margin-top:8px;">
                  <label style="display:block; margin-bottom:6px;">Schedule</label>
                  <div class="form-row">
                    <div class="form-group" style="max-width:180px;">
                      <label>Day</label>
                      <select id="scheduleDay" class="form-input">
                        <option>Monday</option>
                        <option>Tuesday</option>
                        <option>Wednesday</option>
                        <option>Thursday</option>
                        <option>Friday</option>
                        <option>Saturday</option>
                        <option>Sunday</option>
                      </select>
                    </div>
                    <div class="form-group" style="max-width:160px;">
                      <label>Start</label>
                      <div style="display:flex; gap:6px;">
                        <input type="number" id="startHour" class="form-input" min="1" max="12" placeholder="2" style="width:48px;">
                        <input type="number" id="startMin" class="form-input" min="0" max="59" placeholder="00" style="width:56px;">
                        <select id="startAmpm" class="form-input" style="width:72px;">
                          <option>AM</option><option>PM</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-group" style="max-width:160px;">
                      <label>End</label>
                      <div style="display:flex; gap:6px;">
                        <input type="number" id="endHour" class="form-input" min="1" max="12" placeholder="3" style="width:48px;">
                        <input type="number" id="endMin" class="form-input" min="0" max="59" placeholder="00" style="width:56px;">
                        <select id="endAmpm" class="form-input" style="width:72px;">
                          <option>AM</option><option>PM</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:10px;">
                  <button class="cancel-btn" id="cancelCreateSection">Cancel</button>
                  <button id="saveSectionBtn" class="save-question-btn">Add Section</button>
                </div>
              </div>
            </div>
          </div>

          <div id="sectionListWrap" style="width:100%; max-width:920px;">
            <h3 style="color:#501121; margin-bottom:8px;">Sections</h3>
            <!-- Scrollable box that contains the grid of section cards -->
            <div class="sections-box">
              <div id="sectionContainer" class="section-container"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Student Modal -->
<div class="account-modal" id="accountModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Create Student Account</h2>
      <span class="close" id="closeAccountModal">&times;</span>
    </div>

    <div class="section-info" style="margin-bottom:16px;">
      <i class="fas fa-users-class"></i> Section: <strong id="modalSectionName">Loading...</strong>
    </div>

    <form id="studentModalForm">
      <div class="form-row">
        <div class="form-group">
          <label>Student Number</label>
          <input type="text" id="modalStudentNumber" class="form-input" required>
        </div>
        <div class="form-group">
          <label>Contact Number</label>
          <input type="tel" id="modalContactNumber" class="form-input" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Address</label>
          <input type="text" id="modalAddress" class="form-input" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="modalUsername" class="form-input" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="modalEmail" class="form-input" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Last Name</label>
          <input type="text" id="modalLastname" class="form-input" required>
        </div>
        <div class="form-group">
          <label>First Name</label>
          <input type="text" id="modalFirstname" class="form-input" required>
        </div>
        <div class="form-group">
          <label>Middle Initial</label>
          <input type="text" id="modalMiddleInitial" class="form-input" maxlength="2" placeholder="A." />
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="modalPassword" class="form-input" required>
        </div>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:12px;">
        <button type="button" class="cancel-btn" id="cancelModalBtn">Cancel</button>
        <button type="submit" class="save-question-btn">Save Student</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast -->
<div id="successToast" style="display:none; position:fixed; right:20px; bottom:20px; background:#4cc9f0; color:#fff; padding:12px 18px; border-radius:10px; z-index:5000;">
  Student saved.
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

<script>
// --- Integrated logic from user, preserving UI ---
const firebaseConfig = {
  apiKey: "AIzaSyBkmM4hueT7PlnvV8FeRdp8g4rk0qQQrn4",
  authDomain: "midnightmathscape.firebaseapp.com",
  databaseURL: "https://midnightmathscape-e8e70-default-rtdb.firebaseio.com/",
  projectId: "midnightmathscape",
  storageBucket: "midnightmathscape.appspot.com",
  messagingSenderId: "1038485290511",
  appId: "1:1038485290511:web:c8aa78fbcd5266b706ed7a",
};
firebase.initializeApp(firebaseConfig);
const rtdb = firebase.database();

const totalSectionsEl = document.getElementById('totalSections');
const sectionContainer = document.getElementById('sectionContainer');
const saveSectionBtn = document.getElementById('saveSectionBtn');

const accountModal = document.getElementById('accountModal');
const closeAccountModal = document.getElementById('closeAccountModal');
const cancelModalBtn = document.getElementById('cancelModalBtn');
const studentModalForm = document.getElementById('studentModalForm');
const modalSectionNameEl = document.getElementById('modalSectionName');

let activeSectionId = null;
let activeSectionName = '';
let editingSectionId = null; // null = creating new, otherwise editing existing

// Collapsible / create modal controls
const toggleCreateSection = document.getElementById('toggleCreateSection');
const toggleIcon = document.getElementById('toggleIcon');
const createSectionModal = document.getElementById('createSectionModal');
const closeCreateSection = document.getElementById('closeCreateSection');
const cancelCreateSection = document.getElementById('cancelCreateSection');
const createSectionModalTitle = document.getElementById('createSectionModalTitle');

toggleCreateSection.addEventListener('click', () => {
  openCreateSectionModal(null, null);
});
closeCreateSection.addEventListener('click', () => {
  createSectionModal.style.display = 'none';
  toggleIcon.innerHTML = '&#x25BC;';
});
cancelCreateSection.addEventListener('click', () => {
  createSectionModal.style.display = 'none';
  toggleIcon.innerHTML = '&#x25BC;';
});
window.addEventListener('click', ev => {
  if (ev.target === createSectionModal) {
    createSectionModal.style.display = 'none';
    toggleIcon.innerHTML = '&#x25BC;';
  }
});

// Open create/edit modal. If id is provided then populate fields for edit.
function openCreateSectionModal(id=null, data=null){
  editingSectionId = id;
  toggleIcon.innerHTML = (id ? '&#x25B2;' : '&#x25B2;');
  createSectionModal.style.display = 'flex';

  if(id && data){
    createSectionModalTitle.textContent = 'Edit Section';
    saveSectionBtn.textContent = 'Save Changes';
    // populate fields from data (supports single schedule or map)
    document.getElementById('newSectionName').value = data.name || '';
    document.getElementById('newSectionCode').value = data.code || '';
    document.getElementById('newGradeLevel').value = data.gradeLevel || '';

    // pick first schedule found
    let sch = null;
    if(data.schedule){
      if(Array.isArray(data.schedule)) sch = data.schedule[0];
      else if(data.schedule.day) sch = data.schedule;
      else {
        const vals = Object.values(data.schedule);
        sch = vals.length ? vals[0] : null;
      }
    }
    if(sch){
      document.getElementById('scheduleDay').value = sch.day || 'Monday';
      document.getElementById('startHour').value = sch.start?.hour || '';
      document.getElementById('startMin').value = sch.start?.minute || '';
      document.getElementById('startAmpm').value = sch.start?.ampm || 'AM';
      document.getElementById('endHour').value = sch.end?.hour || '';
      document.getElementById('endMin').value = sch.end?.minute || '';
      document.getElementById('endAmpm').value = sch.end?.ampm || 'PM';
    } else {
      // clear schedule inputs
      document.getElementById('scheduleDay').value = 'Monday';
      document.getElementById('startHour').value = '';
      document.getElementById('startMin').value = '';
      document.getElementById('startAmpm').value = 'AM';
      document.getElementById('endHour').value = '';
      document.getElementById('endMin').value = '';
      document.getElementById('endAmpm').value = 'PM';
    }
  } else {
    // creating new
    createSectionModalTitle.textContent = 'Add Section';
    saveSectionBtn.textContent = 'Add Section';
    document.getElementById('newSectionName').value = '';
    document.getElementById('newSectionCode').value = '';
    document.getElementById('newGradeLevel').value = '';
    document.getElementById('scheduleDay').value = 'Monday';
    document.getElementById('startHour').value = '';
    document.getElementById('startMin').value = '';
    document.getElementById('startAmpm').value = 'AM';
    document.getElementById('endHour').value = '';
    document.getElementById('endMin').value = '';
    document.getElementById('endAmpm').value = 'PM';
  }
}

// Save Section (create or update)
saveSectionBtn.addEventListener('click', async () => {
  const name = document.getElementById('newSectionName').value.trim();
  const code = (document.getElementById('newSectionCode').value || '').trim();
  const grade = parseInt(document.getElementById('newGradeLevel').value) || null;
  const day = document.getElementById('scheduleDay').value;
  const startHour = document.getElementById('startHour').value.trim();
  const startMin = document.getElementById('startMin').value.trim();
  const startAmpm = document.getElementById('startAmpm').value;
  const endHour = document.getElementById('endHour').value.trim();
  const endMin = document.getElementById('endMin').value.trim();
  const endAmpm = document.getElementById('endAmpm').value;

  if(!name){ alert('Enter section name'); return; }

  const schedule = {
    day,
    start: { hour: startHour || '', minute: startMin || '', ampm: startAmpm },
    end: { hour: endHour || '', minute: endMin || '', ampm: endAmpm }
  };

  const payload = {
    name,
    code: code || null,
    gradeLevel: grade,
    schedule,
    updatedAt: Date.now()
  };

  if(editingSectionId){
    // update existing
    await rtdb.ref(`SectionList/${editingSectionId}`).update(payload);
  } else {
    // create new
    payload.createdAt = Date.now();
    const newRef = rtdb.ref('SectionList').push();
    await newRef.set(payload);
  }

  // clear form
  document.getElementById('newSectionName').value = '';
  document.getElementById('newSectionCode').value = '';
  document.getElementById('newGradeLevel').value = '';
  document.getElementById('startHour').value = '';
  document.getElementById('startMin').value = '';
  document.getElementById('endHour').value = '';
  document.getElementById('endMin').value = '';

  // hide modal and reset edit mode
  createSectionModal.style.display = 'none';
  toggleIcon.innerHTML = '&#x25BC;';
  editingSectionId = null;
});

/* Real-time Section Listener */
rtdb.ref('SectionList').on('value', snap => {
  sectionContainer.innerHTML = '';
  if(!snap.exists()){ totalSectionsEl.textContent='0'; return; }
  const data = snap.val();
  const entries = Object.entries(data);
  totalSectionsEl.textContent = entries.length;

  // helpers
  function pad(n){ n = n == null ? '' : String(n); if(n==='') return '00'; return n.length===1? '0'+n : n; }
  function formatTimeObj(t){
    if(!t) return '';
    const h = t.hour || '';
    const m = (t.minute==null || t.minute==='') ? '00' : pad(t.minute);
    const am = t.ampm || '';
    if(!h) return '';
    return `${h}:${m} ${am}`.trim();
  }
  function formatRange(s){
    if(!s) return '';
    const start = formatTimeObj(s.start);
    const end = formatTimeObj(s.end);
    return start && end ? `${start} - ${end}` : (start || end || '');
  }

  entries.forEach(([id, sec]) => {
    const card = document.createElement('div');
    card.className='section-card';

    // build schedule HTML (handles single schedule, array or object map)
    let scheduleHTML = '';
    if(sec.schedule){
      if(Array.isArray(sec.schedule)){
        sec.schedule.forEach(sch => {
          scheduleHTML += `<div class="schedule-row"><div>${sch.day||''}</div><div>${formatRange(sch)}</div></div>`;
        });
      } else if(sec.schedule.day){
        scheduleHTML = `<div class="schedule-row"><div>${sec.schedule.day||''}</div><div>${formatRange(sec.schedule)}</div></div>`;
      } else {
        // object with multiple keys
        Object.values(sec.schedule).forEach(sch => {
          scheduleHTML += `<div class="schedule-row"><div>${sch?.day||''}</div><div>${formatRange(sch)}</div></div>`;
        });
      }
    } else {
      scheduleHTML = `<div style="color:#777; padding:8px 0;">No schedule</div>`;
    }

    card.innerHTML = `
      <div class="card-top">
        <div>
          <h3 class="section-title">${sec.name || ''}</h3>
          <div class="section-code">${sec.code || ''}</div>
        </div>
        <div class="card-actions">
          <div class="grade-level">Grade ${sec.gradeLevel ?? '-'}</div>
          <div>
            <button class="icon-btn edit-btn" data-id="${id}" title="Edit"><i class="fas fa-edit"></i></button>
            <button class="delete-btn" data-id="${id}" title="Delete"><i class="fas fa-trash"></i></button>
          </div>
        </div>
      </div>

      <div class="section-code-divider"></div>

      <div class="schedule-list">
        ${scheduleHTML}
      </div>

      <div class="section-code-divider" style="margin-top:8px;"></div>

      <div class="card-footer">
        <div class="student-count">Loading...</div>
        <div>
          <button class="add-btn" data-id="${id}">Add Student</button>
          <a href="#" class="see-students" data-id="${id}">See Students <i class="fas fa-chevron-right"></i></a>
        </div>
      </div>
    `;

    sectionContainer.appendChild(card);

    // events
    const addBtn = card.querySelector('.add-btn');
    if(addBtn) addBtn.addEventListener('click', ()=>openAccountModalForSection(id, sec.name));

    const delBtn = card.querySelector('.delete-btn');
    if(delBtn) delBtn.addEventListener('click', async ()=>{
      if(!confirm('Delete this section?')) return;
      await rtdb.ref(`SectionList/${id}`).remove();
    });

    // edit: open same modal and prefill
    const editBtn = card.querySelector('.edit-btn');
    if(editBtn) editBtn.addEventListener('click', ()=> {
      openCreateSectionModal(id, sec);
    });

    updateStudentCount(id, card);
  });
});

/* Update Student Count */
async function updateStudentCount(sectionId, cardEl){
  const snap = await rtdb.ref('Cridentials').orderByChild('sectionId').equalTo(sectionId).once('value');
  const count = snap.exists()? Object.keys(snap.val()).length : 0;
  const sc = cardEl.querySelector('.student-count');
  if(sc) sc.textContent=`${count} Students`;
}

/* Account Modal */
function openAccountModalForSection(id, name){
  activeSectionId = id;
  activeSectionName = name;
  modalSectionNameEl.textContent = name;
  studentModalForm.reset();
  accountModal.style.display='flex';
}
closeAccountModal.addEventListener('click', ()=>accountModal.style.display='none');
cancelModalBtn.addEventListener('click', ()=>accountModal.style.display='none');
window.addEventListener('click', ev=>{ if(ev.target===accountModal) accountModal.style.display='none'; });

/* Generate 4-digit unique ID */
async function generateUniqueId(){
  let id, exists=true;
  while(exists){
    id=Math.floor(1000+Math.random()*9000).toString();
    const snap=await rtdb.ref(`StudentAccount/${id}`).once('value');
    exists=snap.exists();
  }
  return id;
}

/* Submit Student Form */
studentModalForm.addEventListener('submit', async e=>{
  e.preventDefault();
  if(!activeSectionId) return alert('No section selected');

  const firstname=document.getElementById('modalFirstname').value.trim();
  const lastname=document.getElementById('modalLastname').value.trim();
  const pass=document.getElementById('modalPassword').value;
  const studentNumber=document.getElementById('modalStudentNumber').value.trim();
  const contactNumber=document.getElementById('modalContactNumber').value.trim();
  const address=document.getElementById('modalAddress').value.trim();
  const username=document.getElementById('modalUsername').value.trim();
  const email=document.getElementById('modalEmail').value.trim();

  if(!firstname||!lastname||!pass||!username||!email) return alert('Fill required fields');

  const newId=await generateUniqueId();

  // use canonical 'pass' key to match existing DB usage and avoid duplication
  const middleInitialVal = (document.getElementById('modalMiddleInitial').value||'').trim();
  await rtdb.ref(`StudentAccount/${newId}`).set({ firstName: firstname, lastName: lastname, pass, middleInitial: middleInitialVal });
  await rtdb.ref(`Cridentials/${newId}`).set({ studentNumber,contactNumber,address,username,email,sectionId:activeSectionId,createdAt:Date.now(),status:"active", middleInitial: middleInitialVal });
  // Add student to section's students node
  await rtdb.ref(`SectionList/${activeSectionId}/students/${newId}`).set(true);

  document.getElementById('successToast').style.display='block';
  setTimeout(()=>document.getElementById('successToast').style.display='none',2500);

  accountModal.style.display='none';
});
</script>
</body>
</html>
