<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Settings</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Dashboard styles --- */
        /* -- Formats the body -- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            height: calc(var(--vh, 1vh) * 100); 
            background-color: #09ffce;
        }

        /* -- Sets a box dividing into two sections -- */
        .container-wrap {
          display: flex;
          flex-direction: column-reverse;
          background-color: var(--color-primary-p-50);
          width: 100%;
          height: 100%;
        }

        /* -- Structure of the Main Content -- */
        .-main {
            align-items: flex-start;
            flex-grow: 1;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            justify-content: center;
            background-color: #8A1532;
        }
        
        /* -- Structure of the Side login -- */
        .-side {
            justify-content: left;
            height: 90px;
            background-color: #F4F4F4;
        }

        /* -- Adjusts the two section based on screen -- */
        @media screen {
          .container-wrap {
            display: grid;
            grid-template-columns: .5fr 2fr;
            background-color: #fefefe;
          }

          .-main {
            padding-top: 25%;
          }

          .-side {
            height: auto;
            position: relative;
          }
        }

        /* -- Styles -- */
        .main-menu {
            color: #F0FFDD;
            text-align: center;
            overflow: hidden;
        }
        .main-menu h2 {
            font-size: large;
        }
        
        /* -- main section -- */
        .main-section {
            display: grid;
            line-height: 2;
            text-align: left;
            margin-top: 20%;
            padding-left: 15%;
        }
        .main-section a {
            text-decoration: none;
            color: #F0FFDD;
            font-weight: 300;
        }
        .main-section p {
            filter: opacity(50%);
        }
        
        /* -- settings section -- */
        .settings-section {
            display: grid;
            line-height: 2;
            text-align: left;
            margin-top: 20%;
            padding-left: 15%;
        }
        .settings-section p {
            filter: opacity(50%);
        }
        .settings-section a {
            text-decoration: none;
            color: #F0FFDD;
            font-weight: 300;
        }
        
        /* -- Top bar -- */
        .top-bar {
            background-color: #FFFFFF;
            top: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            height: 80px;
            box-shadow: 0 15px 100px rgba(0,0,0,0.1);
        }
        .top-bar a {
            text-decoration: none;
            color: rgb(31, 31, 31);
            font-weight: 700;
            padding-right: 10%;
        }
        .top-bar i {
            font-size: large;
        }
        
        /* -- Logout area -- */
        .logout {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding-right: 20px;
            gap: 10px;
        }
        
        /* -- info section | anything you want here -- */
        .info {
            margin:auto;
            margin-left: 20px;
            font-size: 39px;
            font-weight: 200;
            margin-bottom: 10px;
        }
        
        /* -- Main Dashboard window -- */
        .dash-window {
            padding-top: 3%;
            padding-left: 5%;
            color: #501121;
            width: auto;
        }
        .header-title h1 {
            background-image: linear-gradient(#c6284f, #541122);
            color: transparent;
            background-clip: text;
            font-size: 50px;
            margin-bottom: 1%;
        }
        
        /* -- Account Creation Form Styles -- */
        .account-creation-form {
            margin-top: 30px;
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 800px;
        }
        
        .account-creation-form h3 {
            color: #501121;
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .input-group {
            flex: 1;
            min-width: 250px;
            position: relative;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .input-group input, 
        .input-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ccc;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        .input-group input:focus, 
        .input-group select:focus {
            outline: none;
            border-color: #8A1532;
        }
        
        .form-actions {
            margin-top: 30px;
        }
        
        button[type="submit"] {
            background-color: #8A1532;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.3s ease;
            width: 100%;
        }
        
        button[type="submit"]:hover {
            background-color: #501121;
        }

        /* users list */
        .users-section { margin-top: 20px; max-width: 1100px; }
        /* table variant (studentList style + chevron) */
        .users-table { width:100%; border-collapse:collapse; background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 6px 16px rgba(0,0,0,0.04); }
        .users-table thead { background: linear-gradient(90deg,#f7f7f7,#fff); }
        .users-table th, .users-table td { padding:12px 16px; text-align:left; border-bottom:1px solid #f5f5f5; color:#40101a; vertical-align:middle; }
        .users-table th { font-weight:700; color:#541122; font-size:0.95rem; }
        .users-table tr:hover td { background:#fff7f7; }
        .chevron { color:#8A1532; margin-left:8px; opacity:.9; }
        .action-btn { padding:6px 8px; border-radius:8px; border:0; cursor:pointer; font-weight:600; margin-left:6px; }
        .btn-reset { background:#f5f5f5; color:#333; border:1px solid #eee; }
        .btn-change { background:#fff3f4; color:#7e142a; border:1px solid rgba(126,20,42,0.06); }
        .btn-delete { background:#fff; color:#d64f4f; border:1px solid rgba(214,79,79,0.08); }
        @media (max-width:768px) {
            .users-table th:nth-child(3), .users-table td:nth-child(3) { display:none; } /* hide providers/created on small */
        }
        /* -- Responsive adjustments -- */
        @media (max-width: 768px) {
            .container-wrap {
                grid-template-columns: 1fr;
            }
            
            .-main {
                padding-top: 15%;
            }
            
            .account-creation-form {
                margin: 20px;
                padding: 15px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            .user-card { flex-direction:column; align-items:flex-start; }
            .user-actions { width:100%; justify-content:flex-end; }
        }
    </style>
</head>
<body>
    <div class="container-wrap">
        <!-- Sidebar -->
        <div class="-main">
            <div class="main-menu">
                <img src="images/profile logo.PNG" alt="logo" width="60" height="60" title="St. Michael Academy">
                <h2 id="displayName">Loading...</h2>
                <p id="userRole">Loading...</p>
                
                <div class="main-section">
                    <p>Main</p>
                    <a href="studentList.html" id="studentListLink">Student List</a>
                    <a href="studentProgress.html" id="studentProgressLink">Student Progress</a>
                    <a href="evalControl.html" id="evalControlLink">Evaluation & Control</a>
                    <a href="accSecSetup.html" id="accSecSetupLink" class="active">Account & Section Setup</a>
                </div>
                
                <div class="settings-section">
                    <p>Settings</p>
                    <a href="settingsPage.html" id="settingsLink">Account Settings</a>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="-side">
            <div class="top-bar">
                <div></div> <!-- Empty div to balance the space-between alignment -->
                <div class="logout" id="logoutBtn">
                    <span>Logout</span>
                    <i class="fas fa-sign-out"></i>
                </div>
            </div>
            
            <div class="dash-window">
                
                
                <!-- Account Creation Section -->
                <div class="account-creation-form" id="accountCreationSection">
                    <h3>Create New Account</h3>
                    
                    <form id="createUserForm">
                        <div class="form-row">
                            <div class="input-group">
                                <label for="newUserName">Full Name</label>
                                <input type="text" id="newUserName" placeholder="Teacher's full name" required>
                            </div>
                            
                            <div class="input-group">
                                <label for="newUserEmail">Email</label>
                                <input type="email" id="newUserEmail" placeholder="Teacher's email" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="input-group">
                                <label for="newUserPassword">Password</label>
                                <input type="password" id="newUserPassword" placeholder="Set password (min 6 characters)" required minlength="6">
                            </div>
                            
                            <div class="input-group">
                                <label for="newUserRole">Role</label>
                                <select id="newUserRole" required>
                                    <option value="teacher">Teacher</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit">Create Account</button>
                        </div>
                    </form>
                </div>

                <!-- Users Section (Authentication accounts) -->
                <div class="users-section">
                    <h3 style="margin-bottom:8px;">All Authentication Accounts</h3>
                    <table class="users-table" aria-label="Authentication accounts">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Providers / Created</th>
                                <th style="width:220px;text-align:right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script>
        // CONFIG: set this to your deployed Cloud Function base URL (example: https://us-central1-YOUR-PROJECT.cloudfunctions.net/api)
        const FUNCTIONS_BASE = 'https://us-central1-YOUR-PROJECT.cloudfunctions.net/api';

        // Firebase initialization
        const firebaseConfig = {
            apiKey: "AIzaSyDNp5EX5oKWWIFWjQ5o5e5MnaVZTgFVLwo",
            authDomain: "midnightmathscape-e8e70.firebaseapp.com",
            databaseURL: "https://midnightmathscape-e8e70-default-rtdb.firebaseio.com",
            projectId: "midnightmathscape-e8e70",
            storageBucket: "midnightmathscape-e8e70.firebasestorage.app",
            messagingSenderId: "643428213528",
            appId: "1:643428213528:web:e14dfea52725d1b647746d",
            measurementId: "G-FTYBFHGQ4T"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Helper: call Cloud Function with current user's idToken (throws on network failure)
        async function callApi(path, body = {}) {
            const user = auth.currentUser;
            if (!user) throw new Error('Not signed in');
            const idToken = await user.getIdToken();
            const res = await fetch(FUNCTIONS_BASE + path, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + idToken
                },
                body: JSON.stringify(body)
            });
            // treat non-2xx as error object from function
            const json = await res.json().catch(()=>({ ok:false, error:'Invalid JSON response' }));
            if (!res.ok) throw new Error(json && json.error ? json.error : 'Function returned error');
            return json;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Check auth state
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = 'mainWeb.html';
                    return;
                }

                // Set user info
                document.getElementById('displayName').textContent = user.displayName || user.email;
                
                // Check if admin (UI-level)
                let isAdmin = false;
                const userEmail = (user && user.email) ? String(user.email).trim().toLowerCase() : '';
                try {
                    const doc = await db.collection('users').doc(user.uid).get();
                    if (doc.exists && doc.data()?.role === 'admin') isAdmin = true;
                } catch (e) { console.warn('Failed to read users/doc for role check', e); }
                // Explicit exception: treat these known emails as admin (case-insensitive)
                if (userEmail === 'admin@stmichael.edu.ph' || userEmail === 'admin@stmichael.com') {
                    isAdmin = true;
                }
 
                 if (isAdmin) {
                     document.getElementById('userRole').textContent = 'Administrator';
                     document.getElementById('accountCreationSection').style.display = 'block';
                 } else {
                     document.getElementById('userRole').textContent = 'Teacher';
                     document.getElementById('accountCreationSection').style.display = 'none';
                 }

                // Try cloud functions first; fallback to Firestore-based operations on failure
                try {
                    await loadAuthUsersUsingFunctions();
                } catch (err) {
                    console.warn('Cloud Functions unavailable, falling back to Firestore-based user management:', err);
                    await loadAuthUsersFromFirestore();
                }
            });

            /* ===== Implementation A: Cloud Functions path ===== */
            async function loadAuthUsersUsingFunctions() {
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '<tr><td colspan="4" style="padding:14px;color:#666">Loading accounts...</td></tr>';
                const r = await callApi('/admin/users/list', {}); // may throw
                if (!r.ok) throw new Error(r.error || 'Failed to load');
                const arr = r.users || [];
                tbody.innerHTML = '';
                // render auth users from functions
                const seenEmails = new Set();
                const seenUids = new Set();
                if (arr.length === 0) {
                    // still try to show Firestore users if functions returns empty
                    // (use fallback merge below)
                } else {
                    arr.forEach(u => {
                        renderUserRowFunction(u);
                        if (u.email) seenEmails.add(u.email.toLowerCase());
                        if (u.uid) seenUids.add(u.uid);
                    });
                }

                // merge Firestore users so Firestore-only records (or REST-created then saved to Firestore) appear
                try {
                    const snap = await db.collection('users').orderBy('createdAt','desc').get();
                    snap.forEach(doc => {
                        const data = doc.data();
                        const uid = doc.id;
                        const email = (data.email||'').toLowerCase();
                        // avoid duplicates
                        if (seenUids.has(uid) || (email && seenEmails.has(email))) return;
                        // create a minimal object shaped like auth user for rendering
                        renderUserRowFunction({
                            uid,
                            email: data.email || '',
                            displayName: data.name || '(No name)',
                            providerData: [],
                            metadata: { creationTime: (data.createdAt && data.createdAt.toDate) ? data.createdAt.toDate().toLocaleString() : '' }
                        });
                    });
                    // if nothing rendered at all -> show no accounts message
                    if (tbody.children.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" style="padding:14px;color:#666">No accounts found.</td></tr>';
                    }
                } catch (err) {
                    // if Firestore merge fails, still show what we have or an error
                    if (tbody.children.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="4" style="color:#c00;padding:12px">Error loading accounts: ${err.message||err}</td></tr>`;
                    }
                }
            }
            function renderUserRowFunction(u) {
                const tbody = document.getElementById('usersTableBody');
                const tr = document.createElement('tr');
                const created = u.metadata && u.metadata.creationTime ? u.metadata.creationTime : '';
                const providers = (u.providerData||[]).map(p=>p.providerId).join(', ')||'local';
                const isDisabled = !!(u.disabled);
                tr.innerHTML = `
                     <td title="${u.displayName||''}">${u.displayName||'(No name)'} <i class="fas fa-chevron-right chevron" aria-hidden="true"></i></td>
                     <td class="user-email">${u.email||''}</td>
                     <td class="user-meta">Providers: <strong>${providers}</strong><div style="color:#888;font-size:0.85rem;margin-top:6px">${created}</div></td>
                    <td style="text-align:right">
                        <button class="action-btn btn-reset" data-email="${u.email}" title="Reset password"><i class="fas fa-key"></i></button>
                        <button class="action-btn btn-change" data-uid="${u.uid}" title="Change password"><i class="fas fa-pen"></i></button>
                        <button class="action-btn btn-disable" data-uid="${u.uid}" data-email="${u.email||''}" title="${isDisabled ? 'Enable user' : 'Disable user'}"><i class="fas ${isDisabled ? 'fa-user-check' : 'fa-user-slash'}"></i></button>
                        <button class="action-btn btn-delete" data-uid="${u.uid}" title="Delete user"><i class="fas fa-trash"></i></button>
                    </td>
                 `;
                 tbody.appendChild(tr);

                 // helper to toggle visual state of row/button
                 function setRowDisabledVisual(disabled) {
                     const btn = tr.querySelector('.btn-disable');
                     if (!btn) return;
                     btn.title = disabled ? 'Enable user' : 'Disable user';
                     btn.querySelector('i').className = 'fas ' + (disabled ? 'fa-user-check' : 'fa-user-slash');
                     tr.dataset.disabled = disabled ? '1' : '';
                     tr.style.opacity = disabled ? '0.6' : '';
                 }

                 // initialize visual state
                 setRowDisabledVisual(isDisabled);
 
                 tr.querySelector('.btn-reset').addEventListener('click', async (ev) => {
                     const email = ev.currentTarget.dataset.email;
                     if (!email) return alert('No email available');
                     if (!confirm(`Send password reset email to ${email}?`)) return;
                     try { await auth.sendPasswordResetEmail(email); alert('Password reset email sent.'); } catch(err){ alert('Error: '+(err.message||err)); }
                 });
 
                 tr.querySelector('.btn-change').addEventListener('click', async (ev) => {
                     const uid = ev.currentTarget.dataset.uid;
                     const pw = prompt('Enter new password (min 6 chars):');
                     if (pw === null) return;
                     if (pw.length < 6) return alert('Password must be at least 6 characters.');
                     try { const res = await callApi('/admin/users/updatePassword',{uid,password:pw}); if(res.ok) alert('Password updated.'); else alert('Update failed: '+(res.error||'unknown')); } catch(err){ alert('Error: '+(err.message||err)); }
                 });
 
                // Disable / Enable handler: Cloud Functions only approach
                tr.querySelector('.btn-disable').addEventListener('click', async (ev) => {
                    const uid = ev.currentTarget.dataset.uid;
                    const email = ev.currentTarget.dataset.email;
                    const isCurrentlyDisabled = tr.dataset.disabled === '1';
                    
                    if (!uid) return alert('No UID available for this user.');
                    
                    try {
                        if (isCurrentlyDisabled) {
                            // Enable user
                            if (!confirm(`Re-enable account ${email || uid}?`)) return;
                            const res = await callApi('/admin/users/enable', { uid });
                            if (res.ok) {
                                setRowDisabledVisual(false);
                                alert('Account re-enabled.');
                            } else {
                                throw new Error(res.error || 'Enable failed');
                            }
                        } else {
                            // Disable user
                            if (!confirm(`Disable account ${email || uid}? This prevents the user from signing in.`)) return;
                            const res = await callApi('/admin/users/disable', { uid });
                            if (res.ok) {
                                setRowDisabledVisual(true);
                                alert('Account disabled.');
                            } else {
                                throw new Error(res.error || 'Disable failed');
                            }
                        }
                    } catch (err) {
                        alert('Failed to toggle disabled state: ' + (err.message || err));
                    }
                });
 
                 tr.querySelector('.btn-delete').addEventListener('click', async (ev) => {
                     const uid = ev.currentTarget.dataset.uid;
                     if (!confirm('Delete this Authentication user? This permanently removes the account.')) return;
                     try { const res = await callApi('/admin/users/delete',{uid}); if(res.ok){ alert('User deleted.'); tr.remove(); } else alert('Delete failed: '+(res.error||'unknown')); } catch(err){ alert('Error: '+(err.message||err)); }
                 });
             }

            /* ===== Implementation B: Firestore fallback (no Cloud Functions) =====
               - Reads from your Firestore 'users' collection
               - Can create auth users client-side (this signs you out; code asks for admin password to re-login)
               - Can send password-reset emails
               - Can delete Firestore user documents (does NOT delete Authentication user)
            */
            async function loadAuthUsersFromFirestore() {
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '<tr><td colspan="4" style="padding:14px;color:#666">Loading accounts (Firestore)...</td></tr>';
                try {
                    db.collection('users').orderBy('createdAt','desc').onSnapshot(snapshot => {
                        tbody.innerHTML = '';
                        if (snapshot.empty) {
                            tbody.innerHTML = '<tr><td colspan="4" style="padding:14px;color:#666">No accounts found.</td></tr>';
                            return;
                        }
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            const uid = doc.id;
                            const tr = document.createElement('tr');
                            const disabled = !!data.disabled;
                            tr.innerHTML = `
                                <td title="${data.name||''}">${data.name||'(No name)'} <i class="fas fa-chevron-right chevron" aria-hidden="true"></i></td>
                                <td>${data.email||''}</td>
                                <td>Role: <strong>${data.role||'teacher'}</strong></td>
                                <td style="text-align:right">
                                    <button class="action-btn btn-reset" data-uid="${uid}" title="${disabled ? 'Change password (disabled)' : 'Change password'}"><i class="fas fa-key"></i></button>
                                    <button class="action-btn btn-change" data-uid="${uid}" title="Edit"><i class="fas fa-pen"></i></button>
                                    <button class="action-btn btn-disable" data-uid="${uid}" data-email="${data.email||''}" title="${disabled ? 'Enable user' : 'Disable user'}"><i class="fas ${disabled ? 'fa-user-check' : 'fa-user-slash'}"></i></button>
                                    <button class="action-btn btn-delete" data-uid="${uid}" title="Delete"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                            tbody.appendChild(tr);

                            // set visual disabled state
                            if (disabled) {
                                tr.style.opacity = '0.6';
                                tr.dataset.disabled = '1';
                            }

                            tr.querySelector('.btn-reset').addEventListener('click', async (ev) => {
                                const uid = ev.currentTarget.dataset.uid;
                                const pw = prompt('Enter new password (min 6 chars):');
                                if (pw === null) return;
                                if (pw.length < 6) return alert('Password must be at least 6 characters.');
                                try {
                                    const res = await callApi('/admin/users/updatePassword',{uid,password:pw});
                                    if (res.ok) alert('Password updated.');
                                    else alert('Update failed: '+(res.error||'unknown'));
                                } catch(err){ alert('Error: '+(err.message||err)); }
                            });

                            tr.querySelector('.btn-change').addEventListener('click', () => {
                                const name = data.name || '';
                                const role = data.role || 'teacher';
                                const newName = prompt('New name', name);
                                if (newName === null) return;
                                const newRole = prompt('New role (teacher/admin)', role);
                                if (newRole === null) return;
                                db.collection('users').doc(uid).update({ name: newName, role: newRole, updatedAt: firebase.firestore.FieldValue.serverTimestamp() })
                                  .then(()=> alert('Updated.')).catch(err=> alert('Update failed: '+(err.message||err)));
                            });

                            // enable/disable toggle (Firestore-backed)
                            tr.querySelector('.btn-disable').addEventListener('click', async (ev) => {
                                const uid = ev.currentTarget.dataset.uid;
                                const email = ev.currentTarget.dataset.email;
                                const isCurrentlyDisabled = tr.dataset.disabled === '1';
                                
                                try {
                                    if (isCurrentlyDisabled) {
                                        // Enable user
                                        if (!confirm(`Re-enable account ${email || uid}?`)) return;
                                        // Try Cloud Functions first
                                        try {
                                            const res = await callApi('/admin/users/enable', { uid });
                                            if (res.ok) {
                                                tr.style.opacity = '';
                                                tr.dataset.disabled = '';
                                                alert('Account re-enabled.');
                                                return;
                                            }
                                        } catch (cfErr) {
                                            console.warn('Cloud enable failed, using Firestore fallback:', cfErr);
                                        }
                                        // Firestore fallback
                                        await db.collection('users').doc(uid).update({ disabled: false });
                                        tr.style.opacity = '';
                                        tr.dataset.disabled = '';
                                        alert('Account re-enabled.');
                                    } else {
                                        // Disable user
                                        if (!confirm(`Disable account ${email || uid}? This prevents the user from signing in.`)) return;
                                        // Try Cloud Functions first
                                        try {
                                            const res = await callApi('/admin/users/disable', { uid });
                                            if (res.ok) {
                                                tr.style.opacity = '0.6';
                                                tr.dataset.disabled = '1';
                                                alert('Account disabled.');
                                                return;
                                            }
                                        } catch (cfErr) {
                                            console.warn('Cloud disable failed, using Firestore fallback:', cfErr);
                                        }
                                        // Firestore fallback
                                        await db.collection('users').doc(uid).update({ disabled: true });
                                        tr.style.opacity = '0.6';
                                        tr.dataset.disabled = '1';
                                        alert('Account disabled.');
                                    }
                                } catch (err) {
                                    alert('Failed to toggle disabled state: ' + (err.message || err));
                                }
                            });

                            tr.querySelector('.btn-delete').addEventListener('click', async (ev) => {
                                const uid = ev.currentTarget.dataset.uid;
                                if (!confirm('Delete this account record from Firestore? This will NOT delete Authentication user.')) return;
                                try { await db.collection('users').doc(uid).delete(); alert('Record deleted from Firestore.'); } catch(err){ alert('Delete failed: '+(err.message||err)); }
                            });
                        });
                    }, err => {
                        tbody.innerHTML = `<tr><td colspan="4" style="color:#c00;padding:12px">Snapshot error: ${err.message||err}</td></tr>`;
                    });
                } catch (err) {
                    tbody.innerHTML = `<tr><td colspan="4" style="color:#c00;padding:12px">${err.message||err}</td></tr>`;
                }
            }

            // Create user: prefer cloud function create, fallback to REST + Firestore (does NOT sign out admin)
            document.getElementById('createUserForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const name = document.getElementById('newUserName').value.trim();
                const email = document.getElementById('newUserEmail').value.trim();
                const password = document.getElementById('newUserPassword').value;
                const role = document.getElementById('newUserRole').value;
                if (!name || !email || !password) return alert('Fill required fields.');
                const submitBtn = this.querySelector('button[type="submit"]');
                submitBtn.disabled = true;

                // try cloud function create if available
                try {
                    const res = await callApi('/admin/users/create', { email, password, displayName: name, role });
                    if (res.ok) {
                        alert('Account created successfully.');
                        this.reset();
                        // refresh list (function or firestore listener will handle)
                        try { await loadAuthUsersUsingFunctions(); } catch(e){ /* ignore */ }
                        submitBtn.disabled = false;
                        return;
                    } else {
                        throw new Error(res.error || 'Create failed');
                    }
                } catch (fnErr) {
                    console.warn('Cloud create failed, falling back to client-side Auth REST create + Firestore:', fnErr);
                    // Fallback: create the Auth user via Identity Toolkit REST API (does NOT change current signed-in user),
                    // then create/seed Firestore users/doc so UI can list it and admin can edit/delete.
                    try {
                        const apiKey = (typeof firebaseConfig !== 'undefined' && firebaseConfig.apiKey) ? firebaseConfig.apiKey : null;
                        if (!apiKey) throw new Error('Missing firebaseConfig.apiKey');

                        const restRes = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, password, returnSecureToken: true })
                        });
                        const restJson = await restRes.json();
                        if (restJson && restJson.error) throw new Error(restJson.error.message || JSON.stringify(restJson.error));
                        const uid = restJson.localId;
                        // create a Firestore document for the user (mirror what the functions would do)
                        await db.collection('users').doc(uid).set({
                            email,
                            name,
                            role,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            authCreated: true
                        });
                        alert('Account created in Firebase Authentication and saved to Firestore.');
                        this.reset();

                        // update UI: try to reload from functions; if unavailable, render the created user row
                        try {
                            await loadAuthUsersUsingFunctions();
                        } catch (e) {
                            // minimal object to render row
                            renderUserRowFunction({
                                uid,
                                email,
                                displayName: name,
                                providerData: [],
                                metadata: { creationTime: new Date().toLocaleString() }
                            });
                        }
                    } catch (err) {
                        // Final fallback: create Firestore-only record (old behavior)
                        console.warn('REST create failed, falling back to Firestore-only record:', err);
                        try {
                            await db.collection('users').add({
                                email,
                                name,
                                role,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                authCreated: false // marker to indicate Auth account not created yet
                            });
                            alert('Account record created in Firestore. Authentication user NOT created. Deploy Cloud Function or create in Firebase Console to make real Auth account.');
                            this.reset();
                            try { await loadAuthUsersFromFirestore(); } catch(e){ /* ignore */ }
                        } catch (err2) {
                            alert('Failed to create record in Firestore: ' + (err2.message || err2));
                        }
                    } finally {
                        submitBtn.disabled = false;
                    }
                }
            });

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                auth.signOut().then(() => {
                    window.location.href = 'mainWeb.html';
                });
            });
        });
    </script>
</body>
</html>